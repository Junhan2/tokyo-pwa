<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tokyo 2026">
<meta name="theme-color" content="#1a1a1a">
<link rel="manifest" href="/tokyo-pwa/manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a1a'/><text y='68' x='50' text-anchor='middle' font-size='50' fill='white'>ğŸ—¼</text></svg>">
<title>Tokyo 2026</title>
<style>
:root{--bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--sub:#666;--dim:#999;--border:#e8e8e8;--accent:#1a1a1a;--tag:#f0f0f0;--gold:#b8860b;--green:#22c55e;--orange:#f59e0b;--red:#ef4444;--r:14px;--safe-b:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100dvh;-webkit-font-smoothing:antialiased}

/* Layout */
.app{display:flex;flex-direction:column;height:100dvh}
.offline-banner{position:fixed;top:0;left:0;right:0;z-index:9999;background:#ff6b35;color:#fff;text-align:center;padding:4px 16px;font-size:12px;font-weight:600;transform:translateY(-100%);transition:transform .3s ease;padding-top:calc(env(safe-area-inset-top,4px) + 4px)}
.offline-banner.show{transform:translateY(0)}

/* Header */
.hdr{background:var(--card);padding:8px 16px;padding-top:calc(env(safe-area-inset-top,8px) + 4px);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between}
.hdr h1{font-size:15px;font-weight:700;letter-spacing:-.3px}
.hdr .sub{font-size:9px;color:var(--dim)}
.env-pills{display:flex;gap:4px;flex-wrap:wrap}
.pill{font-size:9px;padding:2px 6px;border-radius:10px;background:var(--tag);color:var(--sub);white-space:nowrap;display:flex;align-items:center;gap:2px}
.pill b{color:var(--text);font-weight:600}
.pill.good b{color:var(--green)}.pill.mod b{color:var(--orange)}.pill.bad b{color:var(--red)}

/* Day Tabs */
.dtabs{display:flex;gap:6px;padding:8px 16px;overflow-x:auto;scrollbar-width:none;flex-shrink:0;background:var(--card);border-bottom:1px solid var(--border)}
.dtabs::-webkit-scrollbar{display:none}
.dtab{flex-shrink:0;padding:5px 12px;border-radius:16px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--dim);transition:all .15s;white-space:nowrap;position:relative}
.dtab.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.dtab .today-dot{width:6px;height:6px;border-radius:50%;background:var(--green);position:absolute;top:2px;right:2px}
.dtab.on .today-dot{background:#fff}

/* Map */
.map-wrap{flex-shrink:0;height:200px;position:relative;border-bottom:1px solid var(--border);background:#e8e8e8}
#map{width:100%;height:100%}
.map-loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:6px;color:var(--dim);font-size:12px;background:var(--bg)}
.map-loading.hide{display:none}

/* Main scrollable area */
.main-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(52px + var(--safe-b))}

/* Day summary */
.day-summary{padding:10px 16px;font-size:11px;color:var(--sub);line-height:1.5;background:var(--card);border-bottom:1px solid var(--border)}

/* Spot Cards */
.spots{padding:8px 16px 16px}
.scard{background:var(--card);border-radius:var(--r);margin-bottom:0;border:1px solid var(--border);overflow:hidden}
.scard.visited{opacity:.6}
.scard-top{padding:12px 14px;cursor:pointer;display:flex;align-items:flex-start;gap:10px}
.scard-num{width:26px;height:26px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.scard-num.eat{background:var(--gold)}.scard-num.shop{background:#888}.scard-num.snack{background:#aaa}
.scard-info{flex:1;min-width:0}
.scard-name{font-size:13px;font-weight:600;display:flex;align-items:center;gap:5px}
.scard-name .ja{font-size:10px;color:var(--dim);font-weight:400}
.scard-time{font-size:10px;color:var(--sub);margin-top:2px}
.scard-tags{display:flex;gap:3px;margin-top:5px;flex-wrap:wrap}
.stag{font-size:9px;padding:2px 7px;border-radius:10px;background:var(--tag);color:var(--sub)}
.scard-detail{padding:0 14px 12px;font-size:12px;color:var(--sub);line-height:1.6;border-top:1px solid var(--border);padding-top:10px}
.scard-actions{display:flex;gap:6px;margin-top:8px}
.scard-actions button{flex:1;padding:7px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:11px;cursor:pointer;font-family:inherit}
.scard-actions button:active{background:var(--tag)}
.scard-actions button.done{background:var(--accent);color:#fff;border-color:var(--accent)}
.deeplink-row{display:flex;gap:5px;margin-top:8px}
.deeplink-btn{flex:1;padding:7px 4px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:10px;cursor:pointer;text-align:center;text-decoration:none;color:var(--text);display:flex;align-items:center;justify-content:center;gap:3px}
.deeplink-btn:active{background:var(--tag)}
.memo-area{margin-top:8px}
.memo-area textarea{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;resize:vertical;min-height:50px;outline:none}
.bk-star{cursor:pointer;font-size:14px;opacity:.3;transition:opacity .15s}
.bk-star.on{opacity:1}

/* Transit Connectors */
.transit-conn{display:flex;align-items:center;gap:6px;padding:4px 16px 4px 28px;color:var(--dim);font-size:10px;position:relative}
.transit-conn::before{content:'';position:absolute;left:27px;top:0;bottom:0;border-left:2px dashed var(--border)}
.transit-icon{font-size:12px;z-index:1;background:var(--bg);padding:1px 0}
.transit-time{color:var(--sub);font-weight:500}

/* Bottom Tab */
.btab{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;padding-bottom:var(--safe-b);z-index:100}
.btab-item{flex:1;display:flex;align-items:center;justify-content:center;gap:4px;padding:10px 0 6px;cursor:pointer;color:var(--dim);font-size:12px;font-weight:500;border:none;background:none;font-family:inherit;transition:color .15s}
.btab-item.on{color:var(--accent);font-weight:700}

/* Tools */
.tool-section{padding:12px 16px 16px}
.tool-card{background:var(--card);border-radius:var(--r);padding:14px;margin-bottom:10px;border:1px solid var(--border)}
.tool-card h3{font-size:13px;font-weight:600;margin-bottom:8px}
.tool-row{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.tool-input{flex:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;outline:none}
.tool-input:focus{border-color:var(--accent)}
.tool-rate{font-size:10px;color:var(--dim);text-align:center}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.info-item{background:#fafafa;padding:8px 10px;border-radius:8px}
.info-item .label{font-size:9px;color:var(--dim);margin-bottom:1px}
.info-item .value{font-size:12px;font-weight:600}
.emer-list{display:flex;flex-direction:column;gap:5px}
.emer-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#fafafa;border-radius:8px}
.emer-item .name{font-size:11px;font-weight:500}
.emer-item a{font-size:13px;font-weight:700;color:var(--accent);text-decoration:none}
.transport-tip{font-size:11px;color:var(--sub);line-height:1.6}
.transport-tip b{color:var(--text)}

/* Nearby */
.nb-bar{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;margin-bottom:8px}
.nb-bar::-webkit-scrollbar{display:none}
.nb-chip{flex-shrink:0;padding:5px 12px;border-radius:16px;font-size:11px;border:1px solid var(--border);background:var(--card);cursor:pointer;color:var(--sub)}
.nb-chip.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.nb-item{padding:10px 0;border-bottom:1px solid var(--border)}
.nb-item:last-child{border-bottom:none}
.nb-item-name{font-size:12px;font-weight:600}
.nb-item-meta{font-size:10px;color:var(--sub);margin-top:2px}
.nb-item-link{font-size:10px;color:var(--accent);text-decoration:none;font-weight:500}
.nb-gps-btn{display:block;margin:8px auto;padding:8px 20px;border-radius:16px;border:1px solid var(--accent);background:var(--card);font-size:12px;cursor:pointer;font-family:inherit;font-weight:500}

/* Loading */
.spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="offline-banner" id="offlineBanner">ğŸ“¡ ì˜¤í”„ë¼ì¸ ëª¨ë“œ â€” ìºì‹œëœ ë°ì´í„° ì‚¬ìš© ì¤‘</div>

<div class="app">
  <header class="hdr" id="hdr">
    <div><h1>Tokyo 2026</h1><div class="sub">2.13 â€” 2.17</div></div>
    <div class="env-pills" id="envPills"><div class="pill">ë¡œë”©...</div></div>
  </header>
  <nav class="dtabs" id="dayTabs"></nav>
  <div class="map-wrap" id="mapWrap">
    <div id="map"></div>
    <div class="map-loading" id="mapLoading"><div class="spinner"></div> ì§€ë„ ë¡œë”© ì¤‘...</div>
  </div>
  <div class="main-scroll" id="mainContent"></div>
  <nav class="btab" id="btab"></nav>
</div>

<script>
var API_KEY = 'AIzaSyBNOf3Kz4ehJzLJ8D20WWoaI8qYu3dcI0s';
var HOTEL = {lat:35.7102,lng:139.8116};

var DAYS = [
  {
    date:'2/13 (ëª©)',label:'Day 1',title:'ë„ì°© Â· ì•„ì‚¬ì¿ ì‚¬',isoDate:'2026-02-13',
    summary:'ë‚˜ë¦¬íƒ€ â†’ ìŠ¤ì¹´ì´ë¼ì´ë„ˆ ìš°ì—ë…¸ â†’ ì˜¤ì‹œì•„ê²Œ ì²´í¬ì¸ â†’ ì•„ì‚¬ì¿ ì‚¬ ì‚°ì±… â†’ ì´ìì¹´ì•¼ ì €ë…',
    transit:[
      {icon:'ğŸš„',mode:'ìŠ¤ì¹´ì´ë¼ì´ë„ˆ+ì „ì² ',time:'70ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'15ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'2ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'10ë¶„'}
    ],
    spots:[
      {name:'ë‚˜ë¦¬íƒ€ê³µí•­ ë„ì°©',ja:'æˆç”°ç©ºæ¸¯',time:'14:00',type:'transport',lat:35.7647,lng:140.3864,note:'ìŠ¤ì¹´ì´ë¼ì´ë„ˆ â†’ ìš°ì—ë…¸ (41ë¶„) â†’ í˜¸í…” ì²´í¬ì¸',tags:['ë„ì°©','ìŠ¤ì¹´ì´ë¼ì´ë„ˆ']},
      {name:'Richmond Hotel',ja:'ãƒªãƒƒãƒãƒ¢ãƒ³ãƒ‰ãƒ›ãƒ†ãƒ«æ±äº¬ã‚¹ã‚³ãƒ¼ãƒ¬',time:'15:30',type:'hotel',lat:35.7102,lng:139.8116,note:'ì˜¤ì‹œì•„ê²Œì—­ ë„ë³´ 3ë¶„. ìŠ¤ì¹´ì´íŠ¸ë¦¬ ë·°.',tags:['ìˆ™ì†Œ','ì²´í¬ì¸']},
      {name:'ë„ì¿„ ìŠ¤ì¹´ì´íŠ¸ë¦¬',ja:'æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼',time:'16:00',type:'spot',lat:35.7101,lng:139.8107,note:'í˜¸í…” ë°”ë¡œ ì˜†. ì „ë§ëŒ€ëŠ” ì‹œê°„ ì—¬ìœ  ìˆìœ¼ë©´.',tags:['ëœë“œë§ˆí¬','ì „ë§']},
      {name:'ì„¼ì†Œì§€',ja:'æµ…è‰å¯º',time:'17:00',type:'spot',lat:35.7148,lng:139.7967,note:'ì•„ì‚¬ì¿ ì‚¬ì˜ ìƒì§•. ì €ë… ë¬´ë µ ë¼ì´íŠ¸ì—…ì´ ì•„ë¦„ë‹¤ì›€.',tags:['ì‚¬ì°°','í•„ìˆ˜']},
      {name:'ë‚˜ì¹´ë¯¸ì„¸ë„ë¦¬',ja:'ä»²è¦‹ä¸–é€šã‚Š',time:'17:30',type:'shop',lat:35.7135,lng:139.7966,note:'ë‹êµì•¼ë¼, ì•„ê²Œë§Œì¥¬ ë“± ê°„ì‹ ê±°ë¦¬.',tags:['ì‡¼í•‘','ê°„ì‹']},
      {name:'ì¹´ê²Œì¸ ë„ ë©”ë¡ ë¹µ',ja:'èŠ±æœˆå ‚',time:'17:45',type:'snack',lat:35.7145,lng:139.7941,note:'ì–¼êµ´ í¬ê¸° ë©”ë¡ ë¹µ. ì•„ì‚¬ì¿ ì‚¬ í•„ìˆ˜ ê°„ì‹.',tags:['ê°„ì‹','í•„ìˆ˜']},
      {name:'í˜¸í”„ë§Œ (ì €ë…)',ja:'ãƒ›ãƒƒãƒ”ãƒ¼é€šã‚Š',time:'19:00',type:'eat',lat:35.7118,lng:139.7960,note:'í™‹í”¼ë„ë¦¬. í˜„ì§€ì¸ ë¶„ìœ„ê¸° ì´ìì¹´ì•¼ ê³¨ëª©. ëª¨ì¸ ë‹ˆì½”ë¯¸ ì¶”ì²œ.',tags:['ì €ë…','ì´ìì¹´ì•¼','í˜„ì§€ë§›ì§‘']}
    ]
  },
  {
    date:'2/14 (ê¸ˆ)',label:'Day 2',title:'í›„ì§€ì‚° íˆ¬ì–´',isoDate:'2026-02-14',
    summary:'ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½ í›„ì§€ì‚° 1ì¼ íˆ¬ì–´. ë„ì¿„ì—­ 7:45 ì§‘í•© â†’ í˜¼ë§ˆì¹˜ â†’ ì„¼ê²ê³µì› â†’ ì˜¤ì‹œë…¸í•«ì¹´ì´ â†’ ê°€ì™€êµ¬ì¹˜ì½”',
    transit:[
      {icon:'ğŸš‡',mode:'í•œì¡°ëª¬ì„ â†’ì˜¤í…Œë§ˆì¹˜',time:'20ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'120ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'30ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'40ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'30ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'150ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'}
    ],
    spots:[
      {name:'ë„ì¿„ì—­ ì§‘í•©',ja:'æ±äº¬é§… ä¸¸ã®å†…å—å£',time:'07:45',type:'transport',lat:35.6812,lng:139.7671,note:'ë§ˆë£¨ë…¸ìš°ì¹˜ ë‚¨ìª½ ì¶œêµ¬ â†’ ì‹ ë§ˆë£¨ë…¸ìš°ì¹˜ ë¹Œë”© BEAMS ê°„íŒ ì•„ë˜.',tags:['ì§‘í•©','ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½']},
      {name:'í˜¼ë§ˆì¹˜ ê±°ë¦¬',ja:'æœ¬ç”ºé€šã‚Š',time:'10:00',type:'spot',lat:35.4875,lng:138.8031,note:'í›„ì§€ìš”ì‹œë‹¤ ë ˆíŠ¸ë¡œ ì‡¼í•‘ ìŠ¤íŠ¸ë¦¬íŠ¸. í›„ì§€ì‚° ë°°ê²½ í¬í† ìŠ¤íŒŸ.',tags:['íˆ¬ì–´','í¬í† ìŠ¤íŒŸ']},
      {name:'ì•„ë¼ì¿ ë¼ì•¼ë§ˆ ì„¼ê² ê³µì›',ja:'æ–°å€‰å±±æµ…é–“å…¬åœ’',time:'11:30',type:'spot',lat:35.5031,lng:138.7989,note:'ì˜¤ì¸µíƒ‘ + í›„ì§€ì‚° = ì¼ë³¸ ëŒ€í‘œ í’ê²½. 397ê³„ë‹¨.',tags:['íˆ¬ì–´','ì ˆê²½','í•„ìˆ˜']},
      {name:'ì˜¤ì‹œë…¸ í•«ì¹´ì´',ja:'å¿é‡å…«æµ·',time:'13:30',type:'spot',lat:35.4612,lng:138.8312,note:'í›„ì§€ì‚° ëˆˆë…¹ì€ ë¬¼ 8ê°œ ì—°ëª». ë‘ë¶€ ì•„ì´ìŠ¤í¬ë¦¼ ì¶”ì²œ.',tags:['íˆ¬ì–´','ìì—°']},
      {name:'ê°€ì™€êµ¬ì¹˜ì½”',ja:'æ²³å£æ¹–',time:'15:00',type:'spot',lat:35.5162,lng:138.7520,note:'í›„ì§€ì‚° + í˜¸ìˆ˜ ì „ê²½.',tags:['íˆ¬ì–´','í˜¸ìˆ˜']},
      {name:'í˜¸í…” ë³µê·€',ja:'',time:'18:30',type:'transport',lat:35.7102,lng:139.8116,note:'íˆ¬ì–´ ì¢…ë£Œ í›„ ì˜¤ì‹œì•„ê²Œ ë³µê·€.',tags:['ì´ë™']},
      {name:'ë´ë…¸ìŠ¤ì¼€ (ì €ë…)',ja:'ã§ã‚“ã®ã™ã‘',time:'19:30',type:'eat',lat:35.7108,lng:139.8130,note:'ì˜¤ì‹œì•„ê²Œì—­ ê·¼ì²˜ ì˜¤ë… ì´ìì¹´ì•¼. ë”°ëœ»í•œ ì˜¤ë….',tags:['ì €ë…','ì˜¤ë…','í˜„ì§€ë§›ì§‘']}
    ]
  },
  {
    date:'2/15 (í† )',label:'Day 3',title:'ì¸ í‚¤ì§€ Â· ê¸´ì Â· ì‹œë¶€ì•¼',isoDate:'2026-02-15',
    summary:'ì¸ í‚¤ì§€ ë¨¹ë°© â†’ ê¸´ì ì‡¼í•‘ â†’ ì‹œë¶€ì•¼ í•˜ì¹˜ì½”Â·ìŠ¤í¬ë¨ë¸”Â·ìŠ¤ì¹´ì´ ì „ë§ëŒ€',
    transit:[
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'30ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'15ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'},
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'20ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'1ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'}
    ],
    spots:[
      {name:'ì¸ í‚¤ì§€ ì‹œì¥',ja:'ç¯‰åœ°å ´å¤–å¸‚å ´',time:'09:00',type:'eat',lat:35.6654,lng:139.7707,note:'íƒ€ë§ˆê³ ì•¼í‚¤, í•´ì‚°ë¬¼ ë®ë°¥, ìŠ¤ì‹œ. ì•„ì¹¨ ê²¸ ì ì‹¬ ë¨¹ë°©.',tags:['ì•„ì¹¨','ì‹œì¥','ë¨¹ë°©']},
      {name:'ê¸´ì ì‚°ì±…',ja:'éŠ€åº§',time:'11:30',type:'shop',lat:35.6722,lng:139.7649,note:'ìœ ë‹ˆí´ë¡œ ê¸´ìì , ë¬´ì¸ì–‘í’ˆ, ì´í† ì•¼ ë¬¸êµ¬.',tags:['ì‡¼í•‘','ê±°ë¦¬']},
      {name:'ê¸´ì ì‚¬ì´í†  (ì ì‹¬)',ja:'éŠ€åº§ã•ã„ã¨ã†',time:'12:30',type:'eat',lat:35.6710,lng:139.7632,note:'ë‘íˆ¼í•œ ëˆì¹´ì¸  ëª…ê°€. ë¹ ë¥´ê²Œ íšŒì „.',tags:['ì ì‹¬','ëˆì¹´ì¸ ','ëª…ê°€']},
      {name:'ì‹œë¶€ì•¼ í•˜ì¹˜ì½”',ja:'å¿ çŠ¬ãƒãƒå…¬åƒ',time:'14:30',type:'spot',lat:35.6590,lng:139.7006,note:'ì‹œë¶€ì•¼ì—­ ì• í•˜ì¹˜ì½” ë™ìƒ.',tags:['ëœë“œë§ˆí¬','í¬í† ìŠ¤íŒŸ']},
      {name:'ì‹œë¶€ì•¼ ìŠ¤í¬ë¨ë¸”',ja:'æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«äº¤å·®ç‚¹',time:'14:45',type:'spot',lat:35.6595,lng:139.7004,note:'ì„¸ê³„ì—ì„œ ê°€ì¥ ë°”ìœ êµì°¨ë¡œ. ìŠ¤íƒ€ë²…ìŠ¤ 2ì¸µ.',tags:['ëœë“œë§ˆí¬']},
      {name:'ì‹œë¶€ì•¼ ìŠ¤ì¹´ì´',ja:'SHIBUYA SKY',time:'15:30',type:'spot',lat:35.6584,lng:139.7024,note:'230m ì˜¥ìƒ ì „ë§ëŒ€. í•´ì§ˆë…˜ ì¶”ì²œ. ì‚¬ì „ ì˜ˆë§¤ í•„ìˆ˜.',tags:['ì „ë§ëŒ€','ì˜ˆë§¤í•„ìˆ˜']},
      {name:'ê·œì¹´ì¸  ëª¨í† ë¬´ë¼ (ì €ë…)',ja:'ç‰›ã‹ã¤ã‚‚ã¨æ‘',time:'18:00',type:'eat',lat:35.6612,lng:139.6980,note:'ë°”ì‚­í•œ ê·œì¹´ì¸ ë¥¼ ëŒíŒì— êµ¬ì›Œ ë¨¹ëŠ” ë§›.',tags:['ì €ë…','ê·œì¹´ì¸ ','ì¸ê¸°']}
    ]
  },
  {
    date:'2/16 (ì¼)',label:'Day 4',title:'í•˜ë¼ì£¼ì¿  Â· ì‹ ì£¼ì¿ ',isoDate:'2026-02-16',
    summary:'ë©”ì´ì§€ì§„êµ¬ â†’ ë‹¤ì¼€ì‹œíƒ€ë„ë¦¬Â·ì˜¤ëª¨í…Œì‚°ë„ â†’ ì‹ ì£¼ì¿  ê°€ë¶€í‚¤ì´ˆÂ·ê³¨ë“ ê°€ì´Â·ì˜¤ëª¨ì´ë°ìš”ì½”ì´ˆ',
    transit:[
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'35ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'10ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'1ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'10ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'},
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'15ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'}
    ],
    spots:[
      {name:'ë©”ì´ì§€ì§„êµ¬',ja:'æ˜æ²»ç¥å®®',time:'09:30',type:'spot',lat:35.6764,lng:139.6993,note:'ë„ì‹¬ ì† ê±°ëŒ€í•œ ìˆ². ì•„ì¹¨ì— í•œì í•˜ê³  ê²½ê±´.',tags:['ì‹ ì‚¬','í•„ìˆ˜']},
      {name:'ë‹¤ì¼€ì‹œíƒ€ë„ë¦¬',ja:'ç«¹ä¸‹é€šã‚Š',time:'11:00',type:'shop',lat:35.6702,lng:139.7025,note:'í•˜ë¼ì£¼ì¿ ì˜ ìƒì§•. í¬ë ˆì´í”„, ì†œì‚¬íƒ•.',tags:['ì‡¼í•‘','ê±°ë¦¬']},
      {name:'í•˜ë¼ì£¼ì¿  í¬ë ˆì´í”„',ja:'ãƒãƒªã‚ªãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ—',time:'11:20',type:'snack',lat:35.6699,lng:139.7027,note:'ë”¸ê¸° ì´ˆì½” í¬ë ˆì´í”„ ì¶”ì²œ.',tags:['ê°„ì‹']},
      {name:'ì˜¤ëª¨í…Œì‚°ë„',ja:'è¡¨å‚é“',time:'11:45',type:'shop',lat:35.6654,lng:139.7121,note:'ì„¸ë ¨ëœ ê°€ë¡œìˆ˜ê¸¸. ê±´ì¶•ë¬¼ ìì²´ê°€ ë³¼ê±°ë¦¬.',tags:['ì‡¼í•‘','ê±´ì¶•']},
      {name:'ì¹´ëª¨í† ë„¤ê¸° (ì ì‹¬)',ja:'é´¨toè‘±',time:'12:30',type:'eat',lat:35.6670,lng:139.7090,note:'ì˜¤ë¦¬ ë¼ë©˜ ëª…ê°€. ì§„í•œ êµ­ë¬¼.',tags:['ì ì‹¬','ë¼ë©˜','ëª…ê°€']},
      {name:'ì‹ ì£¼ì¿  ê°€ë¶€í‚¤ì´ˆ íƒ€ì›Œ',ja:'æ­Œèˆä¼ç”ºã‚¿ãƒ¯ãƒ¼',time:'15:00',type:'spot',lat:35.6946,lng:139.7015,note:'2023 ì˜¤í”ˆ. ì—”í„°í…Œì¸ë¨¼íŠ¸ ë³µí•©ì‹œì„¤.',tags:['ëœë“œë§ˆí¬','ì‹ ê·œ']},
      {name:'ì‹ ì£¼ì¿  ê³¨ë“ ê°€ì´',ja:'æ–°å®¿ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³è¡—',time:'17:00',type:'spot',lat:35.6944,lng:139.7041,note:'ì¢ì€ ê³¨ëª©ì— 200+ ì‘ì€ ë°”.',tags:['ê±°ë¦¬','ë°”']},
      {name:'ì˜¤ëª¨ì´ë° ìš”ì½”ì´ˆ (ì €ë…)',ja:'æ€ã„å‡ºæ¨ªä¸',time:'19:00',type:'eat',lat:35.6932,lng:139.6985,note:'ì•¼í‚¤í† ë¦¬ ê³¨ëª©. ì—°ê¸° ììš±í•œ ë ˆíŠ¸ë¡œ ë¶„ìœ„ê¸°.',tags:['ì €ë…','ì•¼í‚¤í† ë¦¬','ê³¨ëª©ë§›ì§‘']}
    ]
  },
  {
    date:'2/17 (ì›”)',label:'Day 5',title:'ì‡¼í•‘ Â· ì¶œë°œ',isoDate:'2026-02-17',
    summary:'ì•„í‚¤í•˜ë°”ë¼/ìš°ì—ë…¸ ë§ˆì§€ë§‰ ì‡¼í•‘ â†’ ìŠ¤ì¹´ì´ë¼ì´ë„ˆë¡œ ë‚˜ë¦¬íƒ€ ê³µí•­',
    transit:[
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'20ë¶„'},
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'5ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'},
      {icon:'ğŸš„',mode:'ìŠ¤ì¹´ì´ë¼ì´ë„ˆ',time:'41ë¶„'}
    ],
    spots:[
      {name:'í˜¸í…” ì²´í¬ì•„ì›ƒ',ja:'',time:'10:00',type:'hotel',lat:35.7102,lng:139.8116,note:'ì§ì€ í”„ë¡ íŠ¸ì— ë§¡ê¸°ê³  ê°€ë³ê²Œ.',tags:['ì²´í¬ì•„ì›ƒ']},
      {name:'ì•„í‚¤í•˜ë°”ë¼',ja:'ç§‹è‘‰åŸ',time:'10:30',type:'shop',lat:35.6984,lng:139.7731,note:'ì „ìì œí’ˆ, í”¼ê·œì–´, ë©´ì„¸. ìš”ë„ë°”ì‹œ ì¹´ë©”ë¼.',tags:['ì‡¼í•‘','ì „ìì œí’ˆ']},
      {name:'ìš°ì—ë…¸ ì•„ë©”ìš”ì½”',ja:'ã‚¢ãƒ¡æ¨ª',time:'11:30',type:'shop',lat:35.7089,lng:139.7745,note:'ì¬ë˜ì‹œì¥ ë¶„ìœ„ê¸°. ê°„ì‹, ê±´ì–´ë¬¼, í™”ì¥í’ˆ.',tags:['ì‡¼í•‘','ì‹œì¥']},
      {name:'ì ì‹¬',ja:'',time:'12:00',type:'eat',lat:35.7089,lng:139.7745,note:'ìš°ì—ë…¸ ê·¼ì²˜ ê°€ë³ê²Œ. ë¼ë©˜ì´ë‚˜ ì†Œë°”.',tags:['ì ì‹¬']},
      {name:'ë‚˜ë¦¬íƒ€ ê³µí•­ ì´ë™',ja:'æˆç”°ç©ºæ¸¯',time:'14:00',type:'transport',lat:35.7647,lng:140.3864,note:'ìš°ì—ë…¸ â†’ ìŠ¤ì¹´ì´ë¼ì´ë„ˆ 41ë¶„. ì¶œë°œ 2ì‹œê°„ ì „ ë„ì°©.',tags:['ì¶œë°œ','ìŠ¤ì¹´ì´ë¼ì´ë„ˆ']}
    ]
  }
];

var TYPE_IC = {spot:'ğŸ“',eat:'ğŸ½ï¸',snack:'ğŸ¡',shop:'ğŸ›ï¸',transport:'ğŸšƒ',hotel:'ğŸ¨'};

// State
var st = {tab:0, day:0, expanded:null, nbType:'restaurant', nbResults:[], nbLoading:false, userLat:null, userLng:null};
var map = null, markers = [], polyline = null;
var weatherData = null, aqiData = null;
var mapReady = false;
var exchangeRate = 0.1085;

// Auto-day (JST)
(function(){
  var jst = new Date().toLocaleDateString('en-CA',{timeZone:'Asia/Tokyo'});
  var idx = DAYS.findIndex(function(d){return d.isoDate===jst});
  if(idx>=0) st.day = idx;
})();

// Storage
function ls(k,v){
  if(v===undefined) try{return JSON.parse(localStorage.getItem('tk26_'+k))}catch(e){return null}
  localStorage.setItem('tk26_'+k,JSON.stringify(v));
}
function isVisited(d,s){return !!(ls('visited')||{})[d+'-'+s]}
function toggleVisited(d,s){var v=ls('visited')||{};var k=d+'-'+s;v[k]=!v[k];if(!v[k])delete v[k];ls('visited',v);render()}
function isBk(d,s){return !!(ls('bk')||{})[d+'-'+s]}
function toggleBk(d,s){var v=ls('bk')||{};var k=d+'-'+s;v[k]=!v[k];if(!v[k])delete v[k];ls('bk',v);render()}
function getMemo(d,s){return(ls('memos')||{})[d+'-'+s]||''}
function setMemo(d,s,t){var m=ls('memos')||{};m[d+'-'+s]=t;if(!t)delete m[d+'-'+s];ls('memos',m)}

// Load cached rate
(function(){var c=ls('rateCache');if(c&&c.rate)exchangeRate=c.rate})();

// Deep links
function openGMap(lat,lng,name){
  window.location='comgooglemaps://?q='+lat+','+lng+'&label='+encodeURIComponent(name);
  setTimeout(function(){window.open('https://www.google.com/maps/search/?api=1&query='+lat+','+lng,'_blank')},500);
}
function openAMap(lat,lng,name){
  window.location='maps://?q='+encodeURIComponent(name)+'&ll='+lat+','+lng;
}
function openTransit(lat,lng){
  window.open('https://www.google.com/maps/dir/?api=1&destination='+lat+','+lng+'&travelmode=transit','_blank');
}

// === RENDER ===
function render(){
  renderDayTabs();
  renderMainContent();
  renderBottomTab();
  updateMapVisibility();
  if(mapReady && st.tab===0) updateMapMarkers();
}

function renderDayTabs(){
  var jst = new Date().toLocaleDateString('en-CA',{timeZone:'Asia/Tokyo'});
  var todayIdx = DAYS.findIndex(function(d){return d.isoDate===jst});
  document.getElementById('dayTabs').innerHTML = DAYS.map(function(d,i){
    return '<div class="dtab'+(st.day===i?' on':'')+'" data-day="'+i+'">'+d.label+(i===todayIdx?'<span class="today-dot"></span>':'')+'<br><span style="font-size:9px">'+d.date+'</span></div>';
  }).join('');
  document.querySelectorAll('.dtab').forEach(function(el){
    el.onclick=function(){st.day=+el.dataset.day;st.expanded=null;render()};
  });
}

function renderMainContent(){
  var el = document.getElementById('mainContent');
  if(st.tab===0) el.innerHTML = renderSpots();
  else el.innerHTML = renderTools();
  bindContentEvents();
}

function renderSpots(){
  var day=DAYS[st.day];
  var h='<div class="day-summary">'+day.summary+'</div><div class="spots">';
  day.spots.forEach(function(s,i){
    var exp=st.expanded===i, vis=isVisited(st.day,i), bk=isBk(st.day,i), memo=getMemo(st.day,i);
    var nc=['eat','snack'].indexOf(s.type)>=0?s.type:'';
    h+='<div class="scard'+(vis?' visited':'')+'" id="spot-'+i+'">';
    h+='<div class="scard-top" data-spot="'+i+'">';
    h+='<div class="scard-num '+nc+'">'+(i+1)+'</div>';
    h+='<div class="scard-info">';
    h+='<div class="scard-name">'+s.name+' <span class="ja">'+s.ja+'</span> <span class="bk-star'+(bk?' on':'')+'" data-bk="'+i+'">'+(bk?'â­':'â˜†')+'</span></div>';
    h+='<div class="scard-time">'+(TYPE_IC[s.type]||'ğŸ“')+' '+s.time+(s.tags?' Â· '+s.tags[0]:'')+'</div>';
    h+='<div class="scard-tags">'+(s.tags||[]).map(function(t){return'<span class="stag">'+t+'</span>'}).join('')+'</div>';
    h+='</div></div>';
    if(exp){
      h+='<div class="scard-detail">'+(s.note||'');
      if(s.lat){
        h+='<div class="deeplink-row">';
        h+='<a class="deeplink-btn" data-gapp="'+i+'">ğŸ—º Google Maps</a>';
        h+='<a class="deeplink-btn" data-amap="'+i+'">ğŸ Apple Maps</a>';
        h+='<a class="deeplink-btn" data-transit="'+i+'">ğŸšƒ ê¸¸ì°¾ê¸°</a>';
        h+='</div>';
      }
      h+='<div class="scard-actions"><button class="'+(vis?'done':'')+'" data-vis="'+i+'">'+(vis?'âœ“ ë°©ë¬¸ì™„ë£Œ':'ë°©ë¬¸ ì²´í¬')+'</button></div>';
      h+='<div class="memo-area"><textarea placeholder="ë©”ëª¨..." data-memo="'+i+'">'+memo+'</textarea></div>';
      h+='</div>';
    }
    h+='</div>';
    if(i<day.spots.length-1&&day.transit&&day.transit[i]){
      var tr=day.transit[i];
      h+='<div class="transit-conn"><span class="transit-icon">'+tr.icon+'</span><span class="transit-time">'+tr.mode+' '+tr.time+'</span></div>';
    }
  });
  h+='</div>';
  return h;
}

function renderTools(){
  var cached=ls('rateCache'), rateAge='';
  if(cached&&cached.ts){
    var m=Math.floor((Date.now()-cached.ts)/60000);
    rateAge=m<1?'ë°©ê¸ˆ ì „':m<60?m+'ë¶„ ì „':m<1440?Math.floor(m/60)+'ì‹œê°„ ì „':Math.floor(m/1440)+'ì¼ ì „';
  }
  var nbChips=['restaurant','cafe','convenience_store','drugstore'];
  var nbLabels={restaurant:'ğŸ½ï¸ ë§›ì§‘',cafe:'â˜• ì¹´í˜',convenience_store:'ğŸª í¸ì˜ì ',drugstore:'ğŸ’Š ë“œëŸ­ìŠ¤í† ì–´'};

  var h='<div class="tool-section">';
  // Exchange
  h+='<div class="tool-card"><h3>ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°</h3>';
  h+='<div class="tool-row"><input type="number" class="tool-input" id="krwInput" placeholder="ì› (KRW)" inputmode="numeric"><span style="font-size:16px">â†’</span><input type="number" class="tool-input" id="jpyInput" placeholder="ì—” (JPY)" inputmode="numeric"></div>';
  h+='<div class="tool-rate">1 KRW â‰ˆ '+exchangeRate.toFixed(4)+' JPY'+(rateAge?' Â· '+rateAge:'')+'</div></div>';

  // Nearby
  h+='<div class="tool-card"><h3>ğŸ“ ì£¼ë³€ ê²€ìƒ‰</h3>';
  h+='<div class="nb-bar">'+nbChips.map(function(c){return'<div class="nb-chip'+(st.nbType===c?' on':'')+'" data-nb="'+c+'">'+nbLabels[c]+'</div>'}).join('')+'</div>';
  if(!st.userLat) h+='<button class="nb-gps-btn" id="gpsBtn">ğŸ“ ìœ„ì¹˜ í—ˆìš©í•˜ê¸°</button>';
  else if(st.nbLoading) h+='<div style="text-align:center;padding:8px;color:var(--dim);font-size:11px"><div class="spinner"></div> ê²€ìƒ‰ ì¤‘...</div>';
  else if(st.nbResults.length) h+=st.nbResults.slice(0,10).map(function(r){
    var star=r.rating?'â˜…'+r.rating+' ':'';
    return'<div class="nb-item"><div class="nb-item-name">'+(r.displayName?.text||'')+'</div><div class="nb-item-meta">'+star+(r.formattedAddress||'')+'</div>'+(r.googleMapsUri?'<a class="nb-item-link" href="'+r.googleMapsUri+'" target="_blank">â†’ Mapsì—ì„œ ë³´ê¸°</a>':'')+'</div>';
  }).join('');
  else h+='<div style="text-align:center;padding:8px;color:var(--dim);font-size:11px">ê²°ê³¼ ì—†ìŒ</div>';
  h+='</div>';

  // Emergency
  h+='<div class="tool-card"><h3>ğŸš¨ ê¸´ê¸‰ ì—°ë½ì²˜</h3><div class="emer-list">';
  h+='<div class="emer-item"><span class="name">ê²½ì°°</span><a href="tel:110">110</a></div>';
  h+='<div class="emer-item"><span class="name">ì†Œë°©/êµ¬ê¸‰</span><a href="tel:119">119</a></div>';
  h+='<div class="emer-item"><span class="name">ì£¼ì¼í•œêµ­ëŒ€ì‚¬ê´€</span><a href="tel:+81335520401">03-3452-7611</a></div>';
  h+='</div></div>';

  // Transport
  h+='<div class="tool-card"><h3>ğŸšƒ êµí†µ íŒ</h3><div class="transport-tip">';
  h+='<b>ìŠ¤ì¹´ì´ë¼ì´ë„ˆ</b>: ë‚˜ë¦¬íƒ€â†”ìš°ì—ë…¸ 41ë¶„ Â¥2,520<br>';
  h+='<b>Suica/Pasmo</b>: í¸ì˜ì  ì¶©ì „, JRÂ·ë©”íŠ¸ë¡œÂ·ë²„ìŠ¤ ì‚¬ìš©<br>';
  h+='<b>ì˜¤ì‹œì•„ê²Œì—­</b>: í•œì¡°ëª¬ì„ , ì•„ì‚¬ì¿ ì‚¬ì„ , ë„ë¶€ ìŠ¤ì¹´ì´íŠ¸ë¦¬ ë¼ì¸<br>';
  h+='<b>ë§‰ì°¨</b>: ëŒ€ë¶€ë¶„ ìì •~0:30. ì•¼ê°„ì€ íƒì‹œ';
  h+='</div></div>';

  // Offline map guide
  h+='<div class="tool-card"><h3>ğŸ“¶ ì˜¤í”„ë¼ì¸ ì§€ë„</h3><div class="transport-tip">';
  h+='<b>Google Maps</b>: ì•± â†’ í”„ë¡œí•„ â†’ ì˜¤í”„ë¼ì¸ ì§€ë„ â†’ ë„ì¿„ ë‹¤ìš´ë¡œë“œ<br>';
  h+='<b>Apple Maps</b>: ì„¤ì • â†’ ì§€ë„ â†’ ì˜¤í”„ë¼ì¸ ì§€ë„ â†’ ë„ì¿„ ì¶”ê°€';
  h+='</div></div>';

  // Japanese
  h+='<div class="tool-card"><h3>ğŸ“Œ ìœ ìš©í•œ ì¼ë³¸ì–´</h3><div class="info-grid">';
  [['ê°ì‚¬í•©ë‹ˆë‹¤','ã‚ã‚ŠãŒã¨ã†'],['ì‹¤ë¡€í•©ë‹ˆë‹¤','ã™ã¿ã¾ã›ã‚“'],['ì–¼ë§ˆì˜ˆìš”?','ã„ãã‚‰ã§ã™ã‹'],['ì´ê±° ì£¼ì„¸ìš”','ã“ã‚Œãã ã•ã„'],['í™”ì¥ì‹¤ ì–´ë””?','ãƒˆã‚¤ãƒ¬ã¯ã©ã“'],['ë§›ìˆì–´ìš”','ãŠã„ã—ã„'],['ê³„ì‚° ë¶€íƒ','ãŠä¼šè¨ˆãŠé¡˜ã„'],['ë„ì™€ì£¼ì„¸ìš”','åŠ©ã‘ã¦ãã ã•ã„']].forEach(function(p){
    h+='<div class="info-item"><div class="label">'+p[0]+'</div><div class="value">'+p[1]+'</div></div>';
  });
  h+='</div></div>';

  // Bookmarks
  h+='<div class="tool-card"><h3>â­ ë¶ë§ˆí¬</h3><div id="bkList" style="font-size:11px;color:var(--sub)">';
  var bks=ls('bk')||{};
  var bkItems=Object.keys(bks).filter(function(k){return bks[k]}).map(function(k){
    var p=k.split('-').map(Number);var spot=DAYS[p[0]]&&DAYS[p[0]].spots[p[1]];
    return spot?'<div style="padding:4px 0;border-bottom:1px solid var(--border)">'+DAYS[p[0]].label+' Â· '+spot.name+'</div>':'';
  }).filter(Boolean);
  h+=bkItems.length?bkItems.join(''):'ë¶ë§ˆí¬ ì—†ìŒ';
  h+='</div></div>';

  h+='</div>';
  return h;
}

function renderBottomTab(){
  document.getElementById('btab').innerHTML =
    '<button class="btab-item'+(st.tab===0?' on':'')+'" data-tab="0">ğŸ“‹ ì¼ì •</button>'+
    '<button class="btab-item'+(st.tab===1?' on':'')+'" data-tab="1">ğŸ”§ ë„êµ¬</button>';
  document.querySelectorAll('.btab-item').forEach(function(el){
    el.onclick=function(){st.tab=+el.dataset.tab;render()};
  });
}

function updateMapVisibility(){
  var wrap=document.getElementById('mapWrap');
  if(st.tab===0){
    wrap.style.display='';
    if(mapReady&&map) google.maps.event.trigger(map,'resize');
  } else {
    wrap.style.display='none';
  }
}

function bindContentEvents(){
  // Spot expand
  document.querySelectorAll('.scard-top').forEach(function(el){
    el.onclick=function(e){
      if(e.target.classList.contains('bk-star'))return;
      var i=+el.dataset.spot;
      st.expanded=st.expanded===i?null:i;
      render();
      if(st.expanded!==null){
        setTimeout(function(){
          var c=document.getElementById('spot-'+i);
          if(c)c.scrollIntoView({behavior:'smooth',block:'center'});
          if(mapReady&&map){
            var s=DAYS[st.day].spots[i];
            if(s.lat)map.panTo({lat:s.lat,lng:s.lng});
          }
        },50);
      }
    };
  });
  // Bookmark
  document.querySelectorAll('.bk-star').forEach(function(el){
    el.onclick=function(e){e.stopPropagation();toggleBk(st.day,+el.dataset.bk)};
  });
  // Visit
  document.querySelectorAll('[data-vis]').forEach(function(el){
    el.onclick=function(){toggleVisited(st.day,+el.dataset.vis)};
  });
  // Deep links
  document.querySelectorAll('[data-gapp]').forEach(function(el){
    el.onclick=function(e){e.preventDefault();var s=DAYS[st.day].spots[+el.dataset.gapp];if(s.lat)openGMap(s.lat,s.lng,s.name)};
  });
  document.querySelectorAll('[data-amap]').forEach(function(el){
    el.onclick=function(e){e.preventDefault();var s=DAYS[st.day].spots[+el.dataset.amap];if(s.lat)openAMap(s.lat,s.lng,s.name)};
  });
  document.querySelectorAll('[data-transit]').forEach(function(el){
    el.onclick=function(e){e.preventDefault();var s=DAYS[st.day].spots[+el.dataset.transit];if(s.lat)openTransit(s.lat,s.lng)};
  });
  // Memo
  document.querySelectorAll('[data-memo]').forEach(function(el){
    el.oninput=function(){setMemo(st.day,+el.dataset.memo,el.value)};
  });
  // Currency
  var ki=document.getElementById('krwInput'),ji=document.getElementById('jpyInput');
  if(ki)ki.oninput=function(){ji.value=ki.value?Math.round(ki.value*exchangeRate):''};
  if(ji)ji.oninput=function(){ki.value=ji.value?Math.round(ji.value/exchangeRate):''};
  // GPS
  var gb=document.getElementById('gpsBtn');
  if(gb)gb.onclick=requestGPS;
  // Nearby chips
  document.querySelectorAll('.nb-chip').forEach(function(el){
    el.onclick=function(){st.nbType=el.dataset.nb;if(st.userLat)searchNearby();else render()};
  });
}

// === MAP (stable, never destroyed) ===
function initMap(){
  mapReady=true;
  document.getElementById('mapLoading').classList.add('hide');
  map=new google.maps.Map(document.getElementById('map'),{
    center:{lat:HOTEL.lat,lng:HOTEL.lng},zoom:13,
    mapTypeControl:false,fullscreenControl:false,streetViewControl:false,zoomControl:true,
    styles:[
      {featureType:'poi.business',stylers:[{visibility:'off'}]},
      {featureType:'transit',elementType:'labels.icon',stylers:[{visibility:'off'}]}
    ]
  });
  updateMapMarkers();
  render();
  fetchEnvData();
}

function updateMapMarkers(){
  if(!map)return;
  markers.forEach(function(m){m.setMap(null)});
  markers=[];
  if(polyline)polyline.setMap(null);
  var day=DAYS[st.day],bounds=new google.maps.LatLngBounds(),pts=[];
  day.spots.forEach(function(s,i){
    if(!s.lat)return;
    var colors={eat:'#b8860b',snack:'#aaa',shop:'#888',spot:'#1a1a1a',transport:'#ccc',hotel:'#555'};
    var m=new google.maps.Marker({
      position:{lat:s.lat,lng:s.lng},map:map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:colors[s.type]||'#999',fillOpacity:1,strokeColor:'#fff',strokeWeight:2},
      label:{text:String(i+1),fontSize:'9px',color:'#fff',fontWeight:'bold'},
      title:s.name
    });
    m.addListener('click',function(){
      st.expanded=i;render();
      setTimeout(function(){var c=document.getElementById('spot-'+i);if(c)c.scrollIntoView({behavior:'smooth',block:'center'})},50);
    });
    markers.push(m);
    bounds.extend({lat:s.lat,lng:s.lng});
    pts.push({lat:s.lat,lng:s.lng});
  });
  if(pts.length>1) polyline=new google.maps.Polyline({path:pts,geodesic:true,strokeColor:'#ccc',strokeWeight:1.5,strokeOpacity:.7,map:map});
  if(pts.length) map.fitBounds(bounds,{top:20,bottom:20,left:30,right:30});
}

// Map load timeout
setTimeout(function(){
  if(!mapReady){
    var ml=document.getElementById('mapLoading');
    if(ml)ml.innerHTML='ì§€ë„ ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤íŒŸ ëª©ë¡ì˜ ë”¥ë§í¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”';
  }
},12000);

// Nearby
function requestGPS(){
  if(!navigator.geolocation)return;
  navigator.geolocation.getCurrentPosition(
    function(p){st.userLat=p.coords.latitude;st.userLng=p.coords.longitude;searchNearby()},
    function(){},
    {enableHighAccuracy:true,timeout:10000}
  );
}
async function searchNearby(){
  st.nbLoading=true;st.nbResults=[];render();
  var types={restaurant:'restaurant',cafe:'cafe',convenience_store:'convenience_store',drugstore:'drugstore'};
  try{
    var r=await fetch('https://places.googleapis.com/v1/places:searchNearby',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-Goog-Api-Key':API_KEY,'X-Goog-FieldMask':'places.displayName,places.rating,places.formattedAddress,places.googleMapsUri'},
      body:JSON.stringify({includedTypes:[types[st.nbType]||'restaurant'],maxResultCount:10,locationRestriction:{circle:{center:{latitude:st.userLat,longitude:st.userLng},radius:800}}})
    });
    var d=await r.json();
    st.nbResults=(d.places||[]).sort(function(a,b){return(b.rating||0)-(a.rating||0)});
  }catch(e){}
  st.nbLoading=false;render();
}

// Env data
async function fetchEnvData(){
  try{
    var r=await fetch('https://weather.googleapis.com/v1/currentConditions:lookup?key='+API_KEY+'&location.latitude='+HOTEL.lat+'&location.longitude='+HOTEL.lng+'&languageCode=ko');
    weatherData=await r.json();
  }catch(e){}
  try{
    var r2=await fetch('https://airquality.googleapis.com/v1/currentConditions:lookup?key='+API_KEY,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({location:{latitude:HOTEL.lat,longitude:HOTEL.lng},extraComputations:['POLLUTANT_CONCENTRATION']})
    });
    aqiData=await r2.json();
  }catch(e){}
  updateEnvPills();
}
function updateEnvPills(){
  var pills=[];
  if(weatherData){
    var t=weatherData.temperature?.degrees;
    if(t!==undefined)pills.push('<div class="pill">ğŸŒ¡ <b>'+Math.round(t)+'Â°</b></div>');
  }
  if(aqiData){
    var idx=aqiData.indexes?.[0];var aqi=idx?.aqi;
    if(aqi){var cls=aqi<=50?'good':aqi<=100?'mod':'bad';var lbl=aqi<=50?'ì¢‹ìŒ':aqi<=100?'ë³´í†µ':'ë‚˜ì¨';
      pills.push('<div class="pill '+cls+'">AQI <b>'+aqi+'</b></div>');
    }
  }
  if(pills.length) document.getElementById('envPills').innerHTML=pills.join('');
}

// Exchange rate
async function fetchRate(){
  try{
    var r=await fetch('https://open.er-api.com/v6/latest/KRW');var d=await r.json();
    if(d.rates&&d.rates.JPY){exchangeRate=d.rates.JPY;ls('rateCache',{rate:exchangeRate,ts:Date.now()})}
  }catch(e){}
}

// Offline
function updateOffline(){
  var b=document.getElementById('offlineBanner');
  if(b){if(navigator.onLine)b.classList.remove('show');else b.classList.add('show')}
}
window.addEventListener('online',function(){updateOffline();fetchRate()});
window.addEventListener('offline',updateOffline);

// SW
if('serviceWorker' in navigator) navigator.serviceWorker.register('/tokyo-pwa/sw.js').catch(function(){});

// Init
fetchRate();
updateOffline();
render();
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNOf3Kz4ehJzLJ8D20WWoaI8qYu3dcI0s&loading=async&callback=initMap"></script>
</body>
</html>
