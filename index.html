<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tokyo 2026">
<meta name="theme-color" content="#1a1a1a">
<link rel="manifest" href="/tokyo-pwa/manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a1a'/><text y='68' x='50' text-anchor='middle' font-size='50' fill='white'>ğŸ—¼</text></svg>">
<title>Tokyo 2026</title>
<style>
:root{--bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--sub:#666;--dim:#999;--border:#e8e8e8;--accent:#1a1a1a;--tag:#f0f0f0;--gold:#b8860b;--green:#22c55e;--orange:#f59e0b;--red:#ef4444;--r:14px;--safe-b:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100dvh;-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100dvh}

/* Offline Banner */
.offline-banner{position:fixed;top:0;left:0;right:0;z-index:9999;background:#ff6b35;color:#fff;text-align:center;padding:4px 16px;font-size:12px;font-weight:600;transform:translateY(-100%);transition:transform .3s ease;padding-top:calc(env(safe-area-inset-top,4px) + 4px)}
.offline-banner.show{transform:translateY(0)}

/* Header */
.hdr{background:var(--card);padding:12px 16px;padding-top:calc(env(safe-area-inset-top,12px) + 8px);border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between}
.hdr-left h1{font-size:17px;font-weight:700;letter-spacing:-.3px}
.hdr-left .sub{font-size:10px;color:var(--dim);margin-top:1px}
.env-pills{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.pill{font-size:9px;padding:3px 8px;border-radius:12px;background:var(--tag);color:var(--sub);white-space:nowrap;display:flex;align-items:center;gap:3px}
.pill b{color:var(--text);font-weight:600}
.pill.good b{color:var(--green)}.pill.mod b{color:var(--orange)}.pill.bad b{color:var(--red)}

/* Content area */
.content{flex:1;overflow:hidden;position:relative}
.page{position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none;padding-bottom:calc(72px + var(--safe-b))}
.page.on{display:block}
.page.map-page{padding-bottom:calc(72px + var(--safe-b));overflow:hidden}

/* Bottom Tab Bar */
.btab{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;padding-bottom:var(--safe-b);z-index:100}
.btab-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0 4px;cursor:pointer;color:var(--dim);transition:color .15s;font-size:10px;gap:2px;border:none;background:none;font-family:inherit}
.btab-item.on{color:var(--accent);font-weight:600}
.btab-item .ico{font-size:20px;line-height:1}

/* Day Tabs */
.dtabs{display:flex;gap:6px;padding:12px 16px 8px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.dtabs::-webkit-scrollbar{display:none}
.dtab{flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--dim);transition:all .15s;white-space:nowrap;position:relative}
.dtab.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.dtab .today-dot{width:6px;height:6px;border-radius:50%;background:var(--green);position:absolute;top:4px;right:4px}
.dtab.on .today-dot{background:#fff}

/* Spot Cards */
.spots{padding:0 16px 16px}
.scard{background:var(--card);border-radius:var(--r);margin-bottom:0;border:1px solid var(--border);overflow:hidden;transition:border-color .15s}
.scard.visited{opacity:.65}
.scard-top{padding:14px 16px;cursor:pointer;display:flex;align-items:flex-start;gap:12px}
.scard-num{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.scard-num.eat{background:var(--gold)}
.scard-num.shop{background:#888}
.scard-num.snack{background:#aaa}
.scard-info{flex:1;min-width:0}
.scard-name{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
.scard-name .ja{font-size:11px;color:var(--dim);font-weight:400}
.scard-time{font-size:11px;color:var(--sub);margin-top:2px}
.scard-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
.stag{font-size:9px;padding:2px 8px;border-radius:10px;background:var(--tag);color:var(--sub)}
.scard-detail{padding:0 16px 14px;font-size:12px;color:var(--sub);line-height:1.7;border-top:1px solid var(--border);margin-top:0;padding-top:12px}
.scard-detail .tip{background:#fafafa;padding:8px 12px;border-radius:8px;margin-top:8px;font-size:11px}
.scard-actions{display:flex;gap:8px;margin-top:10px}
.scard-actions button{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:11px;cursor:pointer;font-family:inherit;transition:all .15s}
.scard-actions button:active{background:var(--tag)}
.scard-actions button.done{background:var(--accent);color:#fff;border-color:var(--accent)}
.memo-area{margin-top:8px}
.memo-area textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;resize:vertical;min-height:60px;outline:none}

/* Deep link buttons */
.deeplink-row{display:flex;gap:6px;margin-top:8px}
.deeplink-btn{flex:1;padding:8px 6px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-size:11px;cursor:pointer;font-family:inherit;text-align:center;text-decoration:none;color:var(--text);display:flex;align-items:center;justify-content:center;gap:4px;transition:background .15s}
.deeplink-btn:active{background:var(--tag)}

/* Transit Connectors */
.transit-conn{display:flex;align-items:center;gap:8px;padding:6px 16px 6px 30px;color:var(--dim);font-size:11px;position:relative}
.transit-conn::before{content:'';position:absolute;left:29px;top:0;bottom:0;width:1px;border-left:2px dashed var(--border)}
.transit-icon{font-size:14px;z-index:1;background:var(--bg);padding:2px 0}
.transit-time{color:var(--sub);font-weight:500}

/* Map */
#map{width:100%;height:100%}

/* Map Fallback */
.map-fallback{padding:16px;overflow-y:auto;height:100%}
.map-fallback-title{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--sub)}
.map-fb-item{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;margin-bottom:8px}
.map-fb-item .name{font-size:13px;font-weight:600}
.map-fb-item .meta{font-size:11px;color:var(--sub);margin-top:2px}
.map-fb-links{display:flex;gap:6px;margin-top:8px}
.map-fb-links a{font-size:11px;color:var(--accent);text-decoration:none;font-weight:500}

/* Nearby / Discover */
.nb-bar{padding:12px 16px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.nb-bar::-webkit-scrollbar{display:none}
.nb-chip{flex-shrink:0;padding:7px 14px;border-radius:20px;font-size:12px;border:1px solid var(--border);background:var(--card);cursor:pointer;color:var(--sub);transition:all .15s}
.nb-chip.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.nb-list{padding:0 16px 16px}
.nb-item{background:var(--card);border-radius:var(--r);padding:14px 16px;margin-bottom:8px;border:1px solid var(--border)}
.nb-item-name{font-size:14px;font-weight:600}
.nb-item-meta{font-size:11px;color:var(--sub);margin-top:3px;display:flex;align-items:center;gap:8px}
.nb-item-meta .star{color:var(--gold)}
.nb-item-addr{font-size:11px;color:var(--dim);margin-top:4px}
.nb-item-link{display:inline-block;margin-top:6px;font-size:11px;color:var(--accent);text-decoration:none;font-weight:500}
.nb-status{text-align:center;padding:40px 16px;color:var(--dim);font-size:13px}
.nb-gps-btn{display:block;margin:12px auto;padding:10px 24px;border-radius:20px;border:1px solid var(--accent);background:var(--card);font-size:13px;cursor:pointer;font-family:inherit;font-weight:500}
.nb-map-wrap{height:220px;margin:0 16px 12px;border-radius:var(--r);overflow:hidden;border:1px solid var(--border)}

/* Tools */
.tool-section{padding:16px}
.tool-card{background:var(--card);border-radius:var(--r);padding:16px;margin-bottom:12px;border:1px solid var(--border)}
.tool-card h3{font-size:14px;font-weight:600;margin-bottom:10px}
.tool-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.tool-input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;outline:none}
.tool-input:focus{border-color:var(--accent)}
.tool-result{font-size:20px;font-weight:700;text-align:center;padding:8px 0}
.tool-rate{font-size:11px;color:var(--dim);text-align:center}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.info-item{background:#fafafa;padding:10px 12px;border-radius:8px}
.info-item .label{font-size:10px;color:var(--dim);margin-bottom:2px}
.info-item .value{font-size:13px;font-weight:600}
.info-item .value a{color:var(--accent);text-decoration:none}
.emer-list{display:flex;flex-direction:column;gap:6px}
.emer-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa;border-radius:8px}
.emer-item .name{font-size:12px;font-weight:500}
.emer-item a{font-size:13px;font-weight:700;color:var(--accent);text-decoration:none}
.transport-tip{font-size:12px;color:var(--sub);line-height:1.7;padding:6px 0}
.transport-tip b{color:var(--text)}

/* Bookmark star */
.bk-star{cursor:pointer;font-size:16px;opacity:.3;transition:opacity .15s}
.bk-star.on{opacity:1}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;gap:8px;padding:20px;color:var(--dim);font-size:12px}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Day summary */
.day-summary{padding:12px 16px;font-size:12px;color:var(--sub);line-height:1.6;background:var(--card);margin:0 16px 12px;border-radius:var(--r);border:1px solid var(--border)}
.day-summary .weather-row{display:flex;gap:12px;margin-top:6px}
.day-summary .weather-row .wi{display:flex;align-items:center;gap:4px;font-size:11px}
</style>
</head>
<body>
<!-- Offline Banner (outside #app) -->
<div class="offline-banner" id="offlineBanner">ğŸ“¡ ì˜¤í”„ë¼ì¸ ëª¨ë“œ â€” ìºì‹œëœ ë°ì´í„° ì‚¬ìš© ì¤‘</div>

<div id="app" class="app"></div>

<script>
// === CONFIG ===
const API_KEY = 'AIzaSyBNOf3Kz4ehJzLJ8D20WWoaI8qYu3dcI0s';
const HOTEL = { lat: 35.7102, lng: 139.8116, name: 'Richmond Hotel Tokyo Skhole' };

// === DATA: 5-Day Itinerary ===
const DAYS = [
  {
    date:'2/13 (ëª©)', label:'Day 1', title:'ë„ì°© Â· ì•„ì‚¬ì¿ ì‚¬', isoDate:'2026-02-13',
    summary:'ë‚˜ë¦¬íƒ€ ë„ì°© â†’ ìŠ¤ì¹´ì´ë¼ì´ë„ˆë¡œ ìš°ì—ë…¸ â†’ ì˜¤ì‹œì•„ê²Œ í˜¸í…” ì²´í¬ì¸ í›„ ì•„ì‚¬ì¿ ì‚¬ ì‚°ì±…. ì„¼ì†Œì§€ì™€ ë‚˜ì¹´ë¯¸ì„¸ë„ë¦¬ë¥¼ ì²œì²œíˆ ë‘˜ëŸ¬ë³´ê³  ì €ë…ì€ í˜„ì§€ ì´ìì¹´ì•¼ì—ì„œ.',
    transit:[
      {icon:'ğŸš„',mode:'ìŠ¤ì¹´ì´ë¼ì´ë„ˆ+ì „ì² ',time:'70ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'15ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'2ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'10ë¶„'}
    ],
    spots:[
      {name:'ë‚˜ë¦¬íƒ€ê³µí•­ ë„ì°©',ja:'æˆç”°ç©ºæ¸¯',time:'14:00',type:'transport',lat:35.7647,lng:140.3864,note:'ìŠ¤ì¹´ì´ë¼ì´ë„ˆ â†’ ìš°ì—ë…¸ (41ë¶„) â†’ í˜¸í…” ì²´í¬ì¸',tags:['ë„ì°©','ìŠ¤ì¹´ì´ë¼ì´ë„ˆ']},
      {name:'Richmond Hotel',ja:'ãƒªãƒƒãƒãƒ¢ãƒ³ãƒ‰ãƒ›ãƒ†ãƒ«æ±äº¬ã‚¹ã‚³ãƒ¼ãƒ¬',time:'15:30',type:'hotel',lat:35.7102,lng:139.8116,note:'ì˜¤ì‹œì•„ê²Œì—­ ë„ë³´ 3ë¶„. ìŠ¤ì¹´ì´íŠ¸ë¦¬ ë·°.',tags:['ìˆ™ì†Œ','ì²´í¬ì¸']},
      {name:'ë„ì¿„ ìŠ¤ì¹´ì´íŠ¸ë¦¬',ja:'æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼',time:'16:00',type:'spot',lat:35.7101,lng:139.8107,note:'í˜¸í…” ë°”ë¡œ ì˜†. ì „ë§ëŒ€ëŠ” ì‹œê°„ ì—¬ìœ  ìˆìœ¼ë©´.',tags:['ëœë“œë§ˆí¬','ì „ë§']},
      {name:'ì„¼ì†Œì§€',ja:'æµ…è‰å¯º',time:'17:00',type:'spot',lat:35.7148,lng:139.7967,note:'ì•„ì‚¬ì¿ ì‚¬ì˜ ìƒì§•. ì €ë… ë¬´ë µ ë¼ì´íŠ¸ì—…ì´ ì•„ë¦„ë‹¤ì›€.',tags:['ì‚¬ì°°','í•„ìˆ˜']},
      {name:'ë‚˜ì¹´ë¯¸ì„¸ë„ë¦¬',ja:'ä»²è¦‹ä¸–é€šã‚Š',time:'17:30',type:'shop',lat:35.7135,lng:139.7966,note:'ë‹êµì•¼ë¼, ì•„ê²Œë§Œì¥¬ ë“± ê°„ì‹ ê±°ë¦¬.',tags:['ì‡¼í•‘','ê°„ì‹']},
      {name:'ì¹´ê²Œì¸ ë„ ë©”ë¡ ë¹µ',ja:'èŠ±æœˆå ‚',time:'17:45',type:'snack',lat:35.7145,lng:139.7941,note:'ì–¼êµ´ í¬ê¸° ë©”ë¡ ë¹µ. ì•„ì‚¬ì¿ ì‚¬ í•„ìˆ˜ ê°„ì‹.',tags:['ê°„ì‹','í•„ìˆ˜']},
      {name:'í˜¸í”„ë§Œ (ì €ë…)',ja:'ãƒ›ãƒƒãƒ”ãƒ¼é€šã‚Š',time:'19:00',type:'eat',lat:35.7118,lng:139.7960,note:'í™‹í”¼ë„ë¦¬(í˜¸í”„ë§Œ ê±°ë¦¬). í˜„ì§€ì¸ ë¶„ìœ„ê¸° ì´ìì¹´ì•¼ ê³¨ëª©. ëª¨ì¸ ë‹ˆì½”ë¯¸ ì¶”ì²œ.',tags:['ì €ë…','ì´ìì¹´ì•¼','í˜„ì§€ë§›ì§‘']}
    ]
  },
  {
    date:'2/14 (ê¸ˆ)', label:'Day 2', title:'í›„ì§€ì‚° íˆ¬ì–´', isoDate:'2026-02-14',
    summary:'ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½ í•œêµ­ì–´ ê°€ì´ë“œ í›„ì§€ì‚° 1ì¼ íˆ¬ì–´. ë„ì¿„ì—­ 7:45 ì§‘í•©, 8:00 ì¶œë°œ. í˜¼ë§ˆì¹˜ ê±°ë¦¬ â†’ ì•„ë¼ì¿ ë¼ì•¼ë§ˆ ì„¼ê² ê³µì› â†’ ì˜¤ì‹œë…¸ í•«ì¹´ì´ â†’ ê°€ì™€êµ¬ì¹˜ì½”. ì €ë…ì€ ì˜¤ì‹œì•„ê²Œ ë³µê·€ í›„.',
    transit:[
      {icon:'ğŸš‡',mode:'í•œì¡°ëª¬ì„ â†’ì˜¤í…Œë§ˆì¹˜',time:'20ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'120ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'30ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'40ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'30ë¶„'},
      {icon:'ğŸšŒ',mode:'íˆ¬ì–´ë²„ìŠ¤',time:'150ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'}
    ],
    spots:[
      {name:'ë„ì¿„ì—­ ì§‘í•©',ja:'æ±äº¬é§… ä¸¸ã®å†…å—å£',time:'07:45',type:'transport',lat:35.6812,lng:139.7671,note:'ë§ˆë£¨ë…¸ìš°ì¹˜ ë‚¨ìª½ ì¶œêµ¬ â†’ ì‹ ë§ˆë£¨ë…¸ìš°ì¹˜ ë¹Œë”© BEAMS ê°„íŒ ì•„ë˜ 1ì¸µ. ì˜¤ì‹œì•„ê²Œì—ì„œ í•œì¡°ëª¬ì„ â†’ì˜¤í…Œë§ˆì¹˜ ì•½ 20ë¶„.',tags:['ì§‘í•©','ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½']},
      {name:'í˜¼ë§ˆì¹˜ ê±°ë¦¬',ja:'æœ¬ç”ºé€šã‚Š',time:'10:00',type:'spot',lat:35.4875,lng:138.8031,note:'í›„ì§€ìš”ì‹œë‹¤ ë ˆíŠ¸ë¡œ ì‡¼í•‘ ìŠ¤íŠ¸ë¦¬íŠ¸. í›„ì§€ì‚° ë°°ê²½ í¬í† ìŠ¤íŒŸ.',tags:['íˆ¬ì–´','í¬í† ìŠ¤íŒŸ']},
      {name:'ì•„ë¼ì¿ ë¼ì•¼ë§ˆ ì„¼ê² ê³µì›',ja:'æ–°å€‰å±±æµ…é–“å…¬åœ’',time:'11:30',type:'spot',lat:35.5031,lng:138.7989,note:'ì˜¤ì¸µíƒ‘ + í›„ì§€ì‚° = ì¼ë³¸ ëŒ€í‘œ í’ê²½. 397ê³„ë‹¨ ì˜¬ë¼ê°€ì•¼ í•¨.',tags:['íˆ¬ì–´','ì ˆê²½','í•„ìˆ˜']},
      {name:'ì˜¤ì‹œë…¸ í•«ì¹´ì´',ja:'å¿é‡å…«æµ·',time:'13:30',type:'spot',lat:35.4612,lng:138.8312,note:'í›„ì§€ì‚° ëˆˆë…¹ì€ ë¬¼ì´ ë§Œë“  8ê°œì˜ ë§‘ì€ ì—°ëª». ë‘ë¶€ ì•„ì´ìŠ¤í¬ë¦¼ ì¶”ì²œ.',tags:['íˆ¬ì–´','ìì—°']},
      {name:'ê°€ì™€êµ¬ì¹˜ì½”',ja:'æ²³å£æ¹–',time:'15:00',type:'spot',lat:35.5162,lng:138.7520,note:'ê°€ì™€êµ¬ì¹˜ì½” ìì—°ìƒí™œê´€. í›„ì§€ì‚° + í˜¸ìˆ˜ ì „ê²½.',tags:['íˆ¬ì–´','í˜¸ìˆ˜']},
      {name:'í˜¸í…” ë³µê·€',ja:'',time:'18:30',type:'transport',lat:35.7102,lng:139.8116,note:'íˆ¬ì–´ ì¢…ë£Œ í›„ ì˜¤ì‹œì•„ê²Œ ë³µê·€.',tags:['ì´ë™']},
      {name:'ë´ë…¸ìŠ¤ì¼€ (ì €ë…)',ja:'ã§ã‚“ã®ã™ã‘',time:'19:30',type:'eat',lat:35.7108,lng:139.8130,note:'ì˜¤ì‹œì•„ê²Œì—­ ê·¼ì²˜ ì˜¤ë… ì´ìì¹´ì•¼. ë”°ëœ»í•œ ì˜¤ë…ìœ¼ë¡œ í•˜ë£¨ ë§ˆë¬´ë¦¬.',tags:['ì €ë…','ì˜¤ë…','í˜„ì§€ë§›ì§‘']}
    ]
  },
  {
    date:'2/15 (í† )', label:'Day 3', title:'ì¸ í‚¤ì§€ Â· ê¸´ì Â· ì‹œë¶€ì•¼', isoDate:'2026-02-15',
    summary:'ì•„ì¹¨ì€ ì¸ í‚¤ì§€ ì‹œì¥ì—ì„œ í•´ì‚°ë¬¼ ë¨¹ë°©. ê¸´ìì—ì„œ ì‡¼í•‘ í›„ ì‹œë¶€ì•¼ë¡œ ì´ë™. í•˜ì¹˜ì½” â†’ ì‹œë¶€ì•¼ ìŠ¤í¬ë¨ë¸” â†’ ì‹œë¶€ì•¼ ìŠ¤ì¹´ì´ ì „ë§ëŒ€.',
    transit:[
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'30ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'15ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'},
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'20ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'1ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'}
    ],
    spots:[
      {name:'ì¸ í‚¤ì§€ ì‹œì¥',ja:'ç¯‰åœ°å ´å¤–å¸‚å ´',time:'09:00',type:'eat',lat:35.6654,lng:139.7707,note:'íƒ€ë§ˆê³ ì•¼í‚¤, í•´ì‚°ë¬¼ ë®ë°¥, ìŠ¤ì‹œ ë“±. ì•„ì¹¨ ê²¸ ì ì‹¬ìœ¼ë¡œ ë¨¹ë°©.',tags:['ì•„ì¹¨','ì‹œì¥','ë¨¹ë°©']},
      {name:'ê¸´ì ì‚°ì±…',ja:'éŠ€åº§',time:'11:30',type:'shop',lat:35.6722,lng:139.7649,note:'ìœ ë‹ˆí´ë¡œ ê¸´ìì , ë¬´ì¸ì–‘í’ˆ, ì´í† ì•¼ ë¬¸êµ¬ ë“±.',tags:['ì‡¼í•‘','ê±°ë¦¬']},
      {name:'ê¸´ì ì‚¬ì´í†  (ì ì‹¬)',ja:'éŠ€åº§ã•ã„ã¨ã†',time:'12:30',type:'eat',lat:35.6710,lng:139.7632,note:'ë‘íˆ¼í•œ ëˆì¹´ì¸  ëª…ê°€. ì ì‹¬ ì¤„ ì„œì§€ë§Œ ë¹ ë¥´ê²Œ íšŒì „.',tags:['ì ì‹¬','ëˆì¹´ì¸ ','ëª…ê°€']},
      {name:'ì‹œë¶€ì•¼ í•˜ì¹˜ì½”',ja:'å¿ çŠ¬ãƒãƒå…¬åƒ',time:'14:30',type:'spot',lat:35.6590,lng:139.7006,note:'ì‹œë¶€ì•¼ì—­ ì• í•˜ì¹˜ì½” ë™ìƒ. í¬í† ìŠ¤íŒŸ.',tags:['ëœë“œë§ˆí¬','í¬í† ìŠ¤íŒŸ']},
      {name:'ì‹œë¶€ì•¼ ìŠ¤í¬ë¨ë¸”',ja:'æ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«äº¤å·®ç‚¹',time:'14:45',type:'spot',lat:35.6595,lng:139.7004,note:'ì„¸ê³„ì—ì„œ ê°€ì¥ ë°”ìœ êµì°¨ë¡œ. ìŠ¤íƒ€ë²…ìŠ¤ 2ì¸µì—ì„œ ë‚´ë ¤ë‹¤ë³´ê¸°.',tags:['ëœë“œë§ˆí¬']},
      {name:'ì‹œë¶€ì•¼ ìŠ¤ì¹´ì´',ja:'SHIBUYA SKY',time:'15:30',type:'spot',lat:35.6584,lng:139.7024,note:'230m ì˜¥ìƒ ì „ë§ëŒ€. í•´ì§ˆë…˜ ì¶”ì²œ. ì‚¬ì „ ì˜ˆë§¤ í•„ìˆ˜.',tags:['ì „ë§ëŒ€','ì˜ˆë§¤í•„ìˆ˜']},
      {name:'ê·œì¹´ì¸  ëª¨í† ë¬´ë¼ (ì €ë…)',ja:'ç‰›ã‹ã¤ã‚‚ã¨æ‘',time:'18:00',type:'eat',lat:35.6612,lng:139.6980,note:'ë°”ì‚­í•œ ê·œì¹´ì¸ ë¥¼ ëŒíŒì— êµ¬ì›Œ ë¨¹ëŠ” ë§›. ì‹œë¶€ì•¼ì .',tags:['ì €ë…','ê·œì¹´ì¸ ','ì¸ê¸°']}
    ]
  },
  {
    date:'2/16 (ì¼)', label:'Day 4', title:'í•˜ë¼ì£¼ì¿  Â· ì‹ ì£¼ì¿ ', isoDate:'2026-02-16',
    summary:'í•˜ë¼ì£¼ì¿ ì—ì„œ ë‹¤ì¼€ì‹œíƒ€ë„ë¦¬, ì˜¤ëª¨í…Œì‚°ë„ ê±°ë¦¬ ì‚°ì±…. ë©”ì´ì§€ì§„êµ¬ ì°¸ë°° í›„ ì‹ ì£¼ì¿ ë¡œ ì´ë™. ê°€ë¶€í‚¤ì´ˆ íƒ€ì›Œ, ê³¨ë“ ê°€ì´ íƒë°©.',
    transit:[
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'35ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'10ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'1ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'10ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'},
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'15ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'3ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'}
    ],
    spots:[
      {name:'ë©”ì´ì§€ì§„êµ¬',ja:'æ˜æ²»ç¥å®®',time:'09:30',type:'spot',lat:35.6764,lng:139.6993,note:'ë„ì‹¬ ì† ê±°ëŒ€í•œ ìˆ². ì•„ì¹¨ì— ë°©ë¬¸í•˜ë©´ í•œì í•˜ê³  ê²½ê±´.',tags:['ì‹ ì‚¬','í•„ìˆ˜','ì•„ì¹¨ì¶”ì²œ']},
      {name:'ë‹¤ì¼€ì‹œíƒ€ë„ë¦¬',ja:'ç«¹ä¸‹é€šã‚Š',time:'11:00',type:'shop',lat:35.6702,lng:139.7025,note:'í•˜ë¼ì£¼ì¿ ì˜ ìƒì§•. í¬ë ˆì´í”„, ì†œì‚¬íƒ•, ê°œì„± ë„˜ì¹˜ëŠ” ê°€ê²Œë“¤.',tags:['ì‡¼í•‘','ê±°ë¦¬']},
      {name:'í•˜ë¼ì£¼ì¿  í¬ë ˆì´í”„',ja:'ãƒãƒªã‚ªãƒ³ã‚¯ãƒ¬ãƒ¼ãƒ—',time:'11:20',type:'snack',lat:35.6699,lng:139.7027,note:'ë‹¤ì¼€ì‹œíƒ€ë„ë¦¬ ì…êµ¬. ë”¸ê¸° ì´ˆì½” í¬ë ˆì´í”„ ì¶”ì²œ.',tags:['ê°„ì‹']},
      {name:'ì˜¤ëª¨í…Œì‚°ë„',ja:'è¡¨å‚é“',time:'11:45',type:'shop',lat:35.6654,lng:139.7121,note:'ì„¸ë ¨ëœ ê°€ë¡œìˆ˜ê¸¸. ê±´ì¶•ë¬¼ ìì²´ê°€ ë³¼ê±°ë¦¬.',tags:['ì‡¼í•‘','ê±´ì¶•']},
      {name:'ì¹´ëª¨í† ë„¤ê¸° (ì ì‹¬)',ja:'é´¨toè‘±',time:'12:30',type:'eat',lat:35.6670,lng:139.7090,note:'ì˜¤ë¦¬ ë¼ë©˜ ëª…ê°€. ì§„í•œ êµ­ë¬¼ê³¼ ì˜¤ë¦¬ê³ ê¸°ê°€ ì¼í’ˆ.',tags:['ì ì‹¬','ë¼ë©˜','ëª…ê°€']},
      {name:'ì‹ ì£¼ì¿  ê°€ë¶€í‚¤ì´ˆ íƒ€ì›Œ',ja:'æ­Œèˆä¼ç”ºã‚¿ãƒ¯ãƒ¼',time:'15:00',type:'spot',lat:35.6946,lng:139.7015,note:'2023 ì˜¤í”ˆ. ì—”í„°í…Œì¸ë¨¼íŠ¸ ë³µí•©ì‹œì„¤.',tags:['ëœë“œë§ˆí¬','ì‹ ê·œ']},
      {name:'ì‹ ì£¼ì¿  ê³¨ë“ ê°€ì´',ja:'æ–°å®¿ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³è¡—',time:'17:00',type:'spot',lat:35.6944,lng:139.7041,note:'ì¢ì€ ê³¨ëª©ì— 200ê°œ ì´ìƒ ì‘ì€ ë°”. ë¶„ìœ„ê¸° ìì²´ê°€ ë§¤ë ¥.',tags:['ê±°ë¦¬','ë°”']},
      {name:'ì˜¤ëª¨ì´ë° ìš”ì½”ì´ˆ (ì €ë…)',ja:'æ€ã„å‡ºæ¨ªä¸',time:'19:00',type:'eat',lat:35.6932,lng:139.6985,note:'ì‹ ì£¼ì¿  ì„œìª½ ì¶œêµ¬ ì•¼í‚¤í† ë¦¬ ê³¨ëª©. ì—°ê¸° ììš±í•œ ë ˆíŠ¸ë¡œ ë¶„ìœ„ê¸°.',tags:['ì €ë…','ì•¼í‚¤í† ë¦¬','ê³¨ëª©ë§›ì§‘']}
    ]
  },
  {
    date:'2/17 (ì›”)', label:'Day 5', title:'ë§ˆì§€ë§‰ ì‡¼í•‘ Â· ì¶œë°œ', isoDate:'2026-02-17',
    summary:'ì˜¤ì „ì— ì•„í‚¤í•˜ë°”ë¼ ë˜ëŠ” ìš°ì—ë…¸ì—ì„œ ë§ˆì§€ë§‰ ì‡¼í•‘. ì˜¤í›„ ë‚˜ë¦¬íƒ€ ê³µí•­ìœ¼ë¡œ ì´ë™.',
    transit:[
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'20ë¶„'},
      {icon:'ğŸš‡',mode:'ì „ì² ',time:'5ë¶„'},
      {icon:'ğŸš¶',mode:'ë„ë³´',time:'5ë¶„'},
      {icon:'ğŸš„',mode:'ìŠ¤ì¹´ì´ë¼ì´ë„ˆ',time:'41ë¶„'}
    ],
    spots:[
      {name:'í˜¸í…” ì²´í¬ì•„ì›ƒ',ja:'',time:'10:00',type:'hotel',lat:35.7102,lng:139.8116,note:'ì§ì€ í”„ë¡ íŠ¸ì— ë§¡ê¸°ê³  ê°€ë³ê²Œ ì´ë™.',tags:['ì²´í¬ì•„ì›ƒ']},
      {name:'ì•„í‚¤í•˜ë°”ë¼',ja:'ç§‹è‘‰åŸ',time:'10:30',type:'shop',lat:35.6984,lng:139.7731,note:'ì „ìì œí’ˆ, í”¼ê·œì–´, ë©´ì„¸ ì‡¼í•‘. ìš”ë„ë°”ì‹œ ì¹´ë©”ë¼ ì¶”ì²œ.',tags:['ì‡¼í•‘','ì „ìì œí’ˆ']},
      {name:'ìš°ì—ë…¸ ì•„ë©”ìš”ì½”',ja:'ã‚¢ãƒ¡æ¨ª',time:'11:30',type:'shop',lat:35.7089,lng:139.7745,note:'ì¬ë˜ì‹œì¥ ë¶„ìœ„ê¸°. ê°„ì‹, ê±´ì–´ë¬¼, í™”ì¥í’ˆ ë“±.',tags:['ì‡¼í•‘','ì‹œì¥']},
      {name:'ì ì‹¬',ja:'',time:'12:00',type:'eat',lat:35.7089,lng:139.7745,note:'ìš°ì—ë…¸/ì•„í‚¤í•˜ë°”ë¼ ê·¼ì²˜ì—ì„œ ê°€ë³ê²Œ. ë¼ë©˜ì´ë‚˜ ì†Œë°”.',tags:['ì ì‹¬']},
      {name:'ë‚˜ë¦¬íƒ€ ê³µí•­ ì´ë™',ja:'æˆç”°ç©ºæ¸¯',time:'14:00',type:'transport',lat:35.7647,lng:140.3864,note:'ìš°ì—ë…¸ â†’ ìŠ¤ì¹´ì´ë¼ì´ë„ˆ 41ë¶„. ì¶œë°œ 2ì‹œê°„ ì „ ë„ì°© ëª©í‘œ.',tags:['ì¶œë°œ','ìŠ¤ì¹´ì´ë¼ì´ë„ˆ']}
    ]
  }
];

const TYPE_IC = {spot:'ğŸ“',eat:'ğŸ½ï¸',snack:'ğŸ¡',shop:'ğŸ›ï¸',transport:'ğŸšƒ',hotel:'ğŸ¨'};
const NB_TYPES = [
  {id:'restaurant',label:'ë§›ì§‘',icon:'ğŸ½ï¸',google:'restaurant'},
  {id:'cafe',label:'ì¹´í˜',icon:'â˜•',google:'cafe'},
  {id:'convenience_store',label:'í¸ì˜ì ',icon:'ğŸª',google:'convenience_store'},
  {id:'tourist_attraction',label:'ê´€ê´‘ì§€',icon:'ğŸ›ï¸',google:'tourist_attraction'},
  {id:'shopping_mall',label:'ì‡¼í•‘',icon:'ğŸ›ï¸',google:'shopping_mall'},
  {id:'drugstore',label:'ë“œëŸ­ìŠ¤í† ì–´',icon:'ğŸ’Š',google:'drugstore'}
];

// === STATE ===
let st = {
  tab: 0,
  day: 0,
  expanded: null,
  nbType: 'restaurant',
  nbResults: [],
  nbLoading: false,
  userLat: null,
  userLng: null
};
let map = null, mapNb = null, markers = [], markersNb = [], polyline = null;
let weatherData = null, aqiData = null;
let mapLoadFailed = false;

// === AUTO-DAY DETECTION (JST) ===
function detectTodayIndex(){
  const jstDate = new Date().toLocaleDateString('en-CA',{timeZone:'Asia/Tokyo'});
  return DAYS.findIndex(d=>d.isoDate===jstDate);
}
(function autoSelectDay(){
  const idx = detectTodayIndex();
  if(idx>=0) st.day = idx;
})();

// === STORAGE ===
function ls(k,v){
  if(v===undefined) try{return JSON.parse(localStorage.getItem('tk26_'+k))}catch(e){return null}
  localStorage.setItem('tk26_'+k, JSON.stringify(v));
}
function isVisited(d,s){return !!(ls('visited')||{})[d+'-'+s]}
function toggleVisited(d,s){const v=ls('visited')||{};const k=d+'-'+s;v[k]=!v[k];if(!v[k])delete v[k];ls('visited',v);render()}
function isBk(d,s){return !!(ls('bk')||{})[d+'-'+s]}
function toggleBk(d,s){const v=ls('bk')||{};const k=d+'-'+s;v[k]=!v[k];if(!v[k])delete v[k];ls('bk',v);render()}
function getMemo(d,s){return (ls('memos')||{})[d+'-'+s]||''}
function setMemo(d,s,txt){const m=ls('memos')||{};m[d+'-'+s]=txt;if(!txt)delete m[d+'-'+s];ls('memos',m)}

// === DEEP LINK HELPERS ===
function openGoogleMapsApp(lat,lng,name){
  const encoded = encodeURIComponent(name);
  const appUrl = 'comgooglemaps://?q='+lat+','+lng+'&label='+encoded;
  const webUrl = 'https://www.google.com/maps/search/?api=1&query='+lat+','+lng;
  window.location = appUrl;
  setTimeout(function(){ window.open(webUrl,'_blank'); },500);
}
function openAppleMaps(lat,lng,name){
  const encoded = encodeURIComponent(name);
  window.location = 'maps://?q='+encoded+'&ll='+lat+','+lng;
}
function openTransitDirections(lat,lng){
  window.open('https://www.google.com/maps/dir/?api=1&destination='+lat+','+lng+'&travelmode=transit','_blank');
}

// === RENDER ===
function render(){
  const app = document.getElementById('app');
  app.innerHTML = renderHeader() + '<div class="content">' +
    renderItinerary() + renderMapPage() + renderNearby() + renderTools() +
    '</div>' + renderBottomTab();
  bindEvents();
  if(st.tab === 0 || st.tab === 1) initMapIfNeeded();
}

function renderHeader(){
  let env = '<div class="pill">ë¡œë”©...</div>';
  if(weatherData || aqiData){
    let pills = [];
    if(weatherData){
      const t = weatherData.temperature?.degrees;
      const h = weatherData.humidity?.percent;
      if(t!==undefined) pills.push('<div class="pill">ğŸŒ¡ <b>'+Math.round(t)+'Â°</b></div>');
      if(h!==undefined) pills.push('<div class="pill">ğŸ’§ <b>'+h+'%</b></div>');
    }
    if(aqiData){
      const idx = aqiData.indexes?.[0];
      const aqi = idx?.aqi;
      const pm25 = aqiData.pollutants?.find(function(p){return p.code==='pm25'});
      const cls = aqi<=50?'good':aqi<=100?'mod':'bad';
      const lbl = aqi<=50?'ì¢‹ìŒ':aqi<=100?'ë³´í†µ':'ë‚˜ì¨';
      if(aqi) pills.push('<div class="pill '+cls+'">AQI <b>'+aqi+' '+lbl+'</b></div>');
      if(pm25) pills.push('<div class="pill '+cls+'">PM2.5 <b>'+pm25.concentration?.value?.toFixed(1)+'</b></div>');
    }
    env = pills.join('');
  }
  return '<div class="hdr"><div class="hdr-left"><h1>Tokyo 2026</h1><div class="sub">2.13 â€” 2.17 Â· ì»¤í”Œ ì—¬í–‰ Â· ì˜¤ì‹œì•„ê²Œ</div></div><div class="env-pills">'+env+'</div></div>';
}

function renderBottomTab(){
  const tabs = [{ico:'ğŸ“‹',l:'ì¼ì •'},{ico:'ğŸ—ºï¸',l:'ì§€ë„'},{ico:'ğŸ“',l:'ì£¼ë³€'},{ico:'ğŸ”§',l:'ë„êµ¬'}];
  return '<div class="btab">' + tabs.map(function(t,i){
    return '<button class="btab-item'+(st.tab===i?' on':'')+'" data-tab="'+i+'"><span class="ico">'+t.ico+'</span>'+t.l+'</button>';
  }).join('') + '</div>';
}

function renderItinerary(){
  const day = DAYS[st.day];
  const todayIdx = detectTodayIndex();
  var dtabs = '<div class="dtabs">' + DAYS.map(function(d,i){
    return '<div class="dtab'+(st.day===i?' on':'')+'" data-day="'+i+'">'+d.label+(i===todayIdx?'<span class="today-dot"></span>':'')+'<br><span style="font-size:10px">'+d.date+'</span></div>';
  }).join('') + '</div>';

  var summary = '<div class="day-summary">'+day.summary+'</div>';

  var spotsHtml = '<div class="spots">';
  day.spots.forEach(function(s,i){
    var exp = st.expanded === i;
    var vis = isVisited(st.day, i);
    var bk = isBk(st.day, i);
    var memo = getMemo(st.day, i);
    var numCls = ['eat','snack'].indexOf(s.type)>=0 ? s.type : '';

    spotsHtml += '<div class="scard'+(vis?' visited':'')+'" id="spot-'+i+'">' +
      '<div class="scard-top" data-spot="'+i+'">' +
        '<div class="scard-num '+numCls+'">'+(i+1)+'</div>' +
        '<div class="scard-info">' +
          '<div class="scard-name">'+s.name+' <span class="ja">'+s.ja+'</span>' +
            ' <span class="bk-star'+(bk?' on':'')+'" data-bk="'+i+'">'+(bk?'â­':'â˜†')+'</span>' +
          '</div>' +
          '<div class="scard-time">'+(TYPE_IC[s.type]||'ğŸ“')+' '+s.time+(s.tags?' Â· '+s.tags[0]:'')+'</div>' +
          '<div class="scard-tags">'+(s.tags||[]).map(function(t){return '<span class="stag">'+t+'</span>'}).join('')+'</div>' +
        '</div>' +
      '</div>';

    if(exp){
      spotsHtml += '<div class="scard-detail">' + (s.note||'');
      if(s.lat){
        spotsHtml += '<div class="deeplink-row">' +
          '<a class="deeplink-btn" data-gapp="'+i+'">ğŸ—º Google Maps</a>' +
          '<a class="deeplink-btn" data-amap="'+i+'">ğŸ Apple Maps</a>' +
          '<a class="deeplink-btn" data-transit="'+i+'">ğŸšƒ ê¸¸ì°¾ê¸°</a>' +
        '</div>';
      }
      spotsHtml += '<div class="scard-actions">' +
        '<button class="'+(vis?'done':'')+'" data-vis="'+i+'">'+(vis?'âœ“ ë°©ë¬¸ì™„ë£Œ':'ë°©ë¬¸ ì²´í¬')+'</button>' +
      '</div>' +
      '<div class="memo-area">' +
        '<textarea placeholder="ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”..." data-memo="'+i+'">'+memo+'</textarea>' +
      '</div></div>';
    }

    spotsHtml += '</div>';

    // Transit connector between spots
    if(i < day.spots.length - 1 && day.transit && day.transit[i]){
      var tr = day.transit[i];
      spotsHtml += '<div class="transit-conn">' +
        '<span class="transit-icon">'+tr.icon+'</span>' +
        '<span class="transit-time">'+tr.mode+' '+tr.time+'</span>' +
      '</div>';
    }
  });
  spotsHtml += '</div>';

  return '<div class="page'+(st.tab===0?' on':'')+'" id="pg-itin">'+dtabs+summary+spotsHtml+'</div>';
}

function renderMapPage(){
  var dtabsHtml = '<div class="dtabs">'+DAYS.map(function(d,i){
    return '<div class="dtab'+(st.day===i?' on':'')+'" data-day="'+i+'">'+d.label+'</div>';
  }).join('')+'</div>';

  if(mapLoadFailed){
    return '<div class="page map-page'+(st.tab===1?' on':'')+'" id="pg-map">'+dtabsHtml+renderMapFallback()+'</div>';
  }
  return '<div class="page map-page'+(st.tab===1?' on':'')+'" id="pg-map">'+dtabsHtml+'<div id="map" style="flex:1"></div></div>';
}

function renderMapFallback(){
  var day = DAYS[st.day];
  var items = day.spots.map(function(s,i){
    if(!s.lat) return '';
    return '<div class="map-fb-item">' +
      '<div class="name">'+(i+1)+'. '+s.name+' <span style="color:var(--dim);font-size:11px">'+s.ja+'</span></div>' +
      '<div class="meta">'+(TYPE_IC[s.type]||'ğŸ“')+' '+s.time+' â€” '+(s.note||'')+'</div>' +
      '<div class="map-fb-links">' +
        '<a href="#" data-gapp="'+i+'">ğŸ—º Google Maps</a>' +
        '<a href="#" data-amap="'+i+'">ğŸ Apple Maps</a>' +
        '<a href="#" data-transit="'+i+'">ğŸšƒ ê¸¸ì°¾ê¸°</a>' +
      '</div></div>';
  }).join('');
  return '<div class="map-fallback"><div class="map-fallback-title">ğŸ“ '+day.label+' â€” '+day.title+' (ì˜¤í”„ë¼ì¸ ëª©ë¡)</div>'+items+'</div>';
}

function renderNearby(){
  var chips = '<div class="nb-bar">' + NB_TYPES.map(function(t){
    return '<div class="nb-chip'+(st.nbType===t.id?' on':'')+'" data-nb="'+t.id+'">'+t.icon+' '+t.label+'</div>';
  }).join('') + '</div>';

  var content = '';
  if(!st.userLat){
    content = '<div class="nb-status">í˜„ì¬ ìœ„ì¹˜ë¥¼ í—ˆìš©í•˜ë©´ ì£¼ë³€ ì¥ì†Œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆì–´ìš”.<button class="nb-gps-btn" id="gpsBtn">ğŸ“ ìœ„ì¹˜ í—ˆìš©í•˜ê¸°</button></div>';
  } else if(st.nbLoading){
    content = '<div class="loading"><div class="spinner"></div>ì£¼ë³€ ê²€ìƒ‰ ì¤‘...</div>';
  } else if(st.nbResults.length === 0){
    content = '<div class="nb-status">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”. ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.</div>';
  } else {
    content = '<div class="nb-map-wrap"><div id="mapNb"></div></div>' +
      '<div class="nb-list">' + st.nbResults.map(function(r){
      var rating = r.rating ? '<span class="star">â˜… '+r.rating+'</span> <span>('+( r.userRatingCount||0)+')</span>' : '';
      var open = r.currentOpeningHours?.openNow;
      var openTxt = open===true?'<span style="color:var(--green)">ì˜ì—…ì¤‘</span>':open===false?'<span style="color:var(--red)">ì˜ì—…ì¢…ë£Œ</span>':'';
      return '<div class="nb-item">' +
        '<div class="nb-item-name">'+(r.displayName?.text||'ì´ë¦„ì—†ìŒ')+'</div>' +
        '<div class="nb-item-meta">'+rating+' '+openTxt+'</div>' +
        '<div class="nb-item-addr">'+(r.formattedAddress||'')+'</div>' +
        (r.googleMapsUri?'<a class="nb-item-link" href="'+r.googleMapsUri+'" target="_blank" rel="noopener">Google Mapsì—ì„œ ë³´ê¸° â†’</a>':'') +
      '</div>';
    }).join('') + '</div>';
  }

  return '<div class="page'+(st.tab===2?' on':'')+'" id="pg-nb">'+chips+content+'</div>';
}

function renderTools(){
  var cached = ls('rateCache');
  var rateAge = '';
  if(cached && cached.ts){
    var mins = Math.floor((Date.now()-cached.ts)/60000);
    if(mins<1) rateAge = 'ë°©ê¸ˆ ì „';
    else if(mins<60) rateAge = mins+'ë¶„ ì „';
    else if(mins<1440) rateAge = Math.floor(mins/60)+'ì‹œê°„ ì „';
    else rateAge = Math.floor(mins/1440)+'ì¼ ì „';
  }

  return '<div class="page'+(st.tab===3?' on':'')+'" id="pg-tools"><div class="tool-section">' +
    '<div class="tool-card"><h3>ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°</h3>' +
      '<div class="tool-row">' +
        '<input type="number" class="tool-input" id="krwInput" placeholder="ì› (KRW)" inputmode="numeric">' +
        '<span style="font-size:18px">â†’</span>' +
        '<input type="number" class="tool-input" id="jpyInput" placeholder="ì—” (JPY)" inputmode="numeric">' +
      '</div>' +
      '<div class="tool-rate" id="rateInfo">1 KRW â‰ˆ '+exchangeRate.toFixed(4)+' JPY'+(rateAge?' Â· ê°±ì‹ : '+rateAge:'')+'</div>' +
    '</div>' +

    '<div class="tool-card"><h3>ğŸš¨ ê¸´ê¸‰ ì—°ë½ì²˜</h3>' +
      '<div class="emer-list">' +
        '<div class="emer-item"><span class="name">ê²½ì°°</span><a href="tel:110">110</a></div>' +
        '<div class="emer-item"><span class="name">ì†Œë°© / êµ¬ê¸‰</span><a href="tel:119">119</a></div>' +
        '<div class="emer-item"><span class="name">ì£¼ì¼í•œêµ­ëŒ€ì‚¬ê´€</span><a href="tel:+81335520401">03-3452-7611</a></div>' +
        '<div class="emer-item"><span class="name">ê´€ê´‘ì•ˆë‚´ (ë‹¤êµ­ì–´)</span><a href="tel:+81570064372">050-3816-2787</a></div>' +
      '</div>' +
    '</div>' +

    '<div class="tool-card"><h3>ğŸšƒ êµí†µ íŒ</h3>' +
      '<div class="transport-tip">' +
        '<b>ìŠ¤ì¹´ì´ë¼ì´ë„ˆ</b>: ë‚˜ë¦¬íƒ€â†”ìš°ì—ë…¸ 41ë¶„, í¸ë„ Â¥2,520<br><br>' +
        '<b>Suica/Pasmo</b>: í¸ì˜ì ì—ì„œ ì¶©ì „. JRÂ·ë©”íŠ¸ë¡œÂ·ë²„ìŠ¤ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥.<br><br>' +
        '<b>ì˜¤ì‹œì•„ê²Œì—­ ë…¸ì„ </b>: í•œì¡°ëª¬ì„ (ì§í†µ), ì•„ì‚¬ì¿ ì‚¬ì„ , ë„ë¶€ ìŠ¤ì¹´ì´íŠ¸ë¦¬ ë¼ì¸<br><br>' +
        '<b>ë§‰ì°¨ ì£¼ì˜</b>: ëŒ€ë¶€ë¶„ ìì •~0:30 ë§‰ì°¨. ì•¼ê°„ì—ëŠ” íƒì‹œ ì´ìš©.<br><br>' +
        '<b>Google Maps</b>: ì¼ë³¸ ëŒ€ì¤‘êµí†µ ê²€ìƒ‰ ì •í™•ë„ ë§¤ìš° ë†’ìŒ. ì ê·¹ í™œìš©!' +
      '</div>' +
    '</div>' +

    '<div class="tool-card"><h3>ğŸ“¶ ì˜¤í”„ë¼ì¸ ì§€ë„ ì•ˆë‚´</h3>' +
      '<div class="transport-tip">' +
        '<b>Google Maps ì˜¤í”„ë¼ì¸</b>: ì•± â†’ í”„ë¡œí•„ â†’ ì˜¤í”„ë¼ì¸ ì§€ë„ â†’ ë„ì¿„ ì˜ì—­ ë‹¤ìš´ë¡œë“œ<br><br>' +
        '<b>Apple Maps ì˜¤í”„ë¼ì¸</b>: ì„¤ì • â†’ ì§€ë„ â†’ ì˜¤í”„ë¼ì¸ ì§€ë„ â†’ ë„ì¿„ ì¶”ê°€<br><br>' +
        '<b>ì¶”ì²œ</b>: ì¶œë°œ ì „ WiFiì—ì„œ ë¯¸ë¦¬ ë‹¤ìš´ë¡œë“œ. ì§€í•˜ì² /ì‹¤ë‚´ì—ì„œë„ ì§€ë„ í™•ì¸ ê°€ëŠ¥!' +
      '</div>' +
    '</div>' +

    '<div class="tool-card"><h3>ğŸ“Œ ìœ ìš©í•œ ì¼ë³¸ì–´</h3>' +
      '<div class="info-grid">' +
        '<div class="info-item"><div class="label">ê°ì‚¬í•©ë‹ˆë‹¤</div><div class="value">ã‚ã‚ŠãŒã¨ã†</div></div>' +
        '<div class="info-item"><div class="label">ì‹¤ë¡€í•©ë‹ˆë‹¤</div><div class="value">ã™ã¿ã¾ã›ã‚“</div></div>' +
        '<div class="info-item"><div class="label">ì–¼ë§ˆì˜ˆìš”?</div><div class="value">ã„ãã‚‰ã§ã™ã‹</div></div>' +
        '<div class="info-item"><div class="label">ì´ê±° ì£¼ì„¸ìš”</div><div class="value">ã“ã‚Œãã ã•ã„</div></div>' +
        '<div class="info-item"><div class="label">í™”ì¥ì‹¤ ì–´ë””?</div><div class="value">ãƒˆã‚¤ãƒ¬ã¯ã©ã“</div></div>' +
        '<div class="info-item"><div class="label">ë§›ìˆì–´ìš”</div><div class="value">ãŠã„ã—ã„</div></div>' +
        '<div class="info-item"><div class="label">ê³„ì‚° ë¶€íƒ</div><div class="value">ãŠä¼šè¨ˆãŠé¡˜ã„</div></div>' +
        '<div class="info-item"><div class="label">ë„ì™€ì£¼ì„¸ìš”</div><div class="value">åŠ©ã‘ã¦ãã ã•ã„</div></div>' +
      '</div>' +
    '</div>' +

    '<div class="tool-card"><h3>â­ ë¶ë§ˆí¬í•œ ì¥ì†Œ</h3>' +
      '<div id="bkList" style="font-size:12px;color:var(--sub)">ë¶ë§ˆí¬í•œ ì¥ì†Œê°€ ì—†ì–´ìš”</div>' +
    '</div>' +
  '</div></div>';
}

// === EVENTS ===
function bindEvents(){
  document.querySelectorAll('.btab-item').forEach(function(el){
    el.onclick = function(){ st.tab = +el.dataset.tab; render(); };
  });
  document.querySelectorAll('.dtab').forEach(function(el){
    el.onclick = function(){ st.day = +el.dataset.day; st.expanded = null; render(); };
  });
  document.querySelectorAll('.scard-top').forEach(function(el){
    el.onclick = function(e){
      if(e.target.classList.contains('bk-star')) return;
      var i = +el.dataset.spot;
      st.expanded = st.expanded===i ? null : i;
      render();
      if(st.expanded!==null) setTimeout(function(){
        var card = document.getElementById('spot-'+i);
        if(card) card.scrollIntoView({behavior:'smooth',block:'center'});
      },50);
    };
  });
  document.querySelectorAll('.bk-star').forEach(function(el){
    el.onclick = function(e){ e.stopPropagation(); toggleBk(st.day, +el.dataset.bk); };
  });
  document.querySelectorAll('[data-vis]').forEach(function(el){
    el.onclick = function(){ toggleVisited(st.day, +el.dataset.vis); };
  });
  // Deep links: Google Maps App
  document.querySelectorAll('[data-gapp]').forEach(function(el){
    el.onclick = function(e){
      e.preventDefault();
      var s = DAYS[st.day].spots[+el.dataset.gapp];
      if(s.lat) openGoogleMapsApp(s.lat,s.lng,s.name);
    };
  });
  // Deep links: Apple Maps
  document.querySelectorAll('[data-amap]').forEach(function(el){
    el.onclick = function(e){
      e.preventDefault();
      var s = DAYS[st.day].spots[+el.dataset.amap];
      if(s.lat) openAppleMaps(s.lat,s.lng,s.name);
    };
  });
  // Deep links: Transit
  document.querySelectorAll('[data-transit]').forEach(function(el){
    el.onclick = function(e){
      e.preventDefault();
      var s = DAYS[st.day].spots[+el.dataset.transit];
      if(s.lat) openTransitDirections(s.lat,s.lng);
    };
  });
  // Memo save
  document.querySelectorAll('[data-memo]').forEach(function(el){
    el.oninput = function(){ setMemo(st.day, +el.dataset.memo, el.value); };
  });
  // GPS button
  var gpsBtn = document.getElementById('gpsBtn');
  if(gpsBtn) gpsBtn.onclick = requestGPS;
  // Nearby chips
  document.querySelectorAll('.nb-chip').forEach(function(el){
    el.onclick = function(){ st.nbType = el.dataset.nb; if(st.userLat) searchNearby(); render(); };
  });
  // Currency
  var krwIn = document.getElementById('krwInput');
  var jpyIn = document.getElementById('jpyInput');
  if(krwIn) krwIn.oninput = function(){ jpyIn.value = krwIn.value ? Math.round(krwIn.value * exchangeRate) : ''; };
  if(jpyIn) jpyIn.oninput = function(){ krwIn.value = jpyIn.value ? Math.round(jpyIn.value / exchangeRate) : ''; };

  // Bookmarks list
  var bkList = document.getElementById('bkList');
  if(bkList){
    var bks = ls('bk')||{};
    var items = Object.keys(bks).filter(function(k){return bks[k]}).map(function(k){
      var parts = k.split('-').map(Number);
      var spot = DAYS[parts[0]]?.spots[parts[1]];
      if(!spot) return '';
      return '<div style="padding:6px 0;border-bottom:1px solid var(--border)">'+DAYS[parts[0]].label+' Â· '+spot.name+' <span style="color:var(--dim)">'+spot.ja+'</span></div>';
    }).filter(Boolean);
    bkList.innerHTML = items.length ? items.join('') : 'ë¶ë§ˆí¬í•œ ì¥ì†Œê°€ ì—†ì–´ìš”';
  }
}

// === GOOGLE MAPS ===
var mapReady = false;
function initMap(){
  mapReady = true;
  clearTimeout(mapLoadTimer);
  initMapIfNeeded();
  render();
  fetchEnvData();
}

function initMapIfNeeded(){
  if(!mapReady) return;

  if(st.tab === 0 || st.tab === 1){
    var el = document.getElementById('map');
    if(!el) return;
    if(!map){
      map = new google.maps.Map(el, {
        center:{lat:HOTEL.lat,lng:HOTEL.lng}, zoom:13,
        mapTypeControl:false, fullscreenControl:false, streetViewControl:false,
        zoomControl:true,
        styles:[
          {featureType:'poi.business',stylers:[{visibility:'off'}]},
          {featureType:'transit',elementType:'labels.icon',stylers:[{visibility:'off'}]}
        ]
      });
    }
    updateMapMarkers();
  }

  if(st.tab === 2 && st.userLat && st.nbResults.length){
    setTimeout(function(){
      var el = document.getElementById('mapNb');
      if(!el || mapNb) return;
      mapNb = new google.maps.Map(el, {
        center:{lat:st.userLat,lng:st.userLng}, zoom:15,
        mapTypeControl:false, fullscreenControl:false, streetViewControl:false, zoomControl:false,
        styles:[{featureType:'poi.business',stylers:[{visibility:'off'}]}]
      });
      new google.maps.Marker({position:{lat:st.userLat,lng:st.userLng},map:mapNb,
        icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:'#4285f4',fillOpacity:1,strokeColor:'#fff',strokeWeight:2}
      });
      st.nbResults.forEach(function(r,i){
        var loc = r.location;
        if(!loc) return;
        var m = new google.maps.Marker({position:{lat:loc.latitude,lng:loc.longitude},map:mapNb,
          label:{text:String(i+1),fontSize:'10px',color:'#fff'},
          icon:{path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:'#1a1a1a',fillOpacity:1,strokeColor:'#fff',strokeWeight:2}
        });
        var info = new google.maps.InfoWindow({
          content:'<div style="font-size:12px;font-family:sans-serif"><b>'+(r.displayName?.text||'')+'</b><br>â˜… '+(r.rating||'-')+'</div>'
        });
        m.addListener('click',function(){info.open(mapNb,m)});
      });
    },100);
  }
}

function updateMapMarkers(){
  if(!map) return;
  markers.forEach(function(m){m.setMap(null)});
  markers = [];
  if(polyline) polyline.setMap(null);

  var day = DAYS[st.day];
  var bounds = new google.maps.LatLngBounds();
  var pts = [];

  day.spots.forEach(function(s,i){
    if(!s.lat) return;
    var colors = {eat:'#b8860b',snack:'#aaa',shop:'#888',spot:'#1a1a1a',transport:'#ccc',hotel:'#555'};
    var c = colors[s.type]||'#999';
    var m = new google.maps.Marker({
      position:{lat:s.lat,lng:s.lng}, map:map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:c,fillOpacity:1,strokeColor:'#fff',strokeWeight:2},
      label:{text:String(i+1),fontSize:'10px',color:'#fff',fontWeight:'bold'},
      title:s.name
    });
    var info = new google.maps.InfoWindow({
      content:'<div style="font-family:sans-serif;font-size:12px;max-width:200px"><b>'+s.name+'</b><br><span style="color:#999;font-size:10px">'+(s.ja||'')+'</span><br><span style="font-size:10px;color:#666">'+(s.note||'')+'</span></div>'
    });
    m.addListener('click',function(){info.open(map,m)});
    markers.push(m);
    bounds.extend({lat:s.lat,lng:s.lng});
    pts.push({lat:s.lat,lng:s.lng});
  });

  if(pts.length > 1){
    polyline = new google.maps.Polyline({path:pts,geodesic:true,strokeColor:'#ccc',strokeWeight:1.5,strokeOpacity:.7,map:map});
  }

  if(pts.length) map.fitBounds(bounds,{top:60,bottom:80,left:40,right:40});
}

// === MAP LOAD TIMEOUT ===
var mapLoadTimer = setTimeout(function(){
  if(!mapReady){
    mapLoadFailed = true;
    render();
  }
},10000);

// === NEARBY SEARCH (Places API) ===
function requestGPS(){
  if(!navigator.geolocation){alert('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì˜ˆìš”.');return;}
  navigator.geolocation.getCurrentPosition(
    function(pos){ st.userLat=pos.coords.latitude; st.userLng=pos.coords.longitude; searchNearby(); },
    function(){ alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); },
    {enableHighAccuracy:true,timeout:10000}
  );
}

async function searchNearby(){
  st.nbLoading = true;
  st.nbResults = [];
  mapNb = null;
  render();

  var typeInfo = NB_TYPES.find(function(t){return t.id===st.nbType});
  try{
    var res = await fetch('https://places.googleapis.com/v1/places:searchNearby', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-Goog-Api-Key':API_KEY,
        'X-Goog-FieldMask':'places.displayName,places.rating,places.userRatingCount,places.formattedAddress,places.location,places.currentOpeningHours,places.googleMapsUri,places.primaryTypeDisplayName'
      },
      body:JSON.stringify({
        includedTypes:[typeInfo.google],
        maxResultCount:15,
        locationRestriction:{circle:{center:{latitude:st.userLat,longitude:st.userLng},radius:800}}
      })
    });
    var data = await res.json();
    st.nbResults = (data.places||[]).sort(function(a,b){return (b.rating||0)-(a.rating||0)});
  }catch(e){ console.error(e); }

  st.nbLoading = false;
  render();
}

// === ENV DATA ===
async function fetchEnvData(){
  var lat = HOTEL.lat, lng = HOTEL.lng;
  try{
    var r = await fetch('https://weather.googleapis.com/v1/currentConditions:lookup?key='+API_KEY+'&location.latitude='+lat+'&location.longitude='+lng+'&languageCode=ko');
    weatherData = await r.json();
  }catch(e){}
  try{
    var r2 = await fetch('https://airquality.googleapis.com/v1/currentConditions:lookup?key='+API_KEY,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({location:{latitude:lat,longitude:lng},extraComputations:['POLLUTANT_CONCENTRATION']})
    });
    aqiData = await r2.json();
  }catch(e){}
  render();
}

// === EXCHANGE RATE (with offline caching) ===
var exchangeRate = 0.1085;
(function loadCachedRate(){
  var cached = ls('rateCache');
  if(cached && cached.rate) exchangeRate = cached.rate;
})();

async function fetchRate(){
  try{
    var r = await fetch('https://open.er-api.com/v6/latest/KRW');
    var d = await r.json();
    if(d.rates && d.rates.JPY){
      exchangeRate = d.rates.JPY;
      ls('rateCache',{rate:exchangeRate,ts:Date.now()});
    }
  }catch(e){
    // offline: use cached rate
  }
}

// === OFFLINE INDICATOR ===
function updateOfflineBanner(){
  var banner = document.getElementById('offlineBanner');
  if(banner){
    if(navigator.onLine) banner.classList.remove('show');
    else banner.classList.add('show');
  }
}
window.addEventListener('online',function(){ updateOfflineBanner(); fetchRate(); });
window.addEventListener('offline',updateOfflineBanner);

// === SERVICE WORKER ===
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/tokyo-pwa/sw.js').catch(function(){});
}

// === INIT ===
fetchRate();
updateOfflineBanner();

// Initial render before Google Maps loads
document.getElementById('app').innerHTML = '<div class="hdr"><div class="hdr-left"><h1>Tokyo 2026</h1><div class="sub">2.13 â€” 2.17 Â· ì»¤í”Œ ì—¬í–‰ Â· ì˜¤ì‹œì•„ê²Œ</div></div><div class="env-pills"><div class="pill">ë¡œë”©...</div></div></div><div class="content"><div class="page on" style="display:flex;align-items:center;justify-content:center;height:100%;padding-bottom:72px"><div class="loading"><div class="spinner"></div>ì§€ë„ ë¡œë”© ì¤‘...</div></div></div><div class="btab"><button class="btab-item on"><span class="ico">ğŸ“‹</span>ì¼ì •</button><button class="btab-item"><span class="ico">ğŸ—ºï¸</span>ì§€ë„</button><button class="btab-item"><span class="ico">ğŸ“</span>ì£¼ë³€</button><button class="btab-item"><span class="ico">ğŸ”§</span>ë„êµ¬</button></div>';
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNOf3Kz4ehJzLJ8D20WWoaI8qYu3dcI0s&loading=async&callback=initMap"></script>
</body>
</html>
